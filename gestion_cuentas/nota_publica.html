<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle de Nota | AEtech</title>
    <link rel="stylesheet" href="cuentas.css"> <style>
        body { background: #f2f2f7; display: flex; justify-content: center; padding: 20px; }
        .public-card { background: white; width: 100%; max-width: 500px; border-radius: 30px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .badge-status { background: #34c759; color: white; padding: 5px 12px; border-radius: 10px; font-size: 12px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="public-card">
        <header style="text-align: center; margin-bottom: 20px; background: transparent;">
            <img src="img/logoAEtech.png" width="80">
            <h2 id="pub-nota-num" style="color: #1c1c1e; margin-top: 10px;">Cargando...</h2>
            <span class="badge-status">Nota Oficial</span>
        </header>

        <div id="pub-detalle">
            <p><strong>Cliente:</strong> <span id="pub-cliente"></span></p>
            <hr style="opacity: 0.1;">
            <div id="pub-lista-materiales"></div>
            
            <div class="lev-totales-container" style="background: rgba(0,0,0,0.03); margin-top: 20px;">
                <div class="lev-total-field"><label>Total:</label> <span id="pub-total" style="font-weight: bold;"></span></div>
                <div class="lev-total-field"><label style="color: #007aff;">Anticipo:</label> <span id="pub-anticipo"></span></div>
                <div class="lev-total-field"><label style="color: #ff3b30;">Saldo:</label> <span id="pub-saldo" style="font-weight: 800; color: #ff3b30;"></span></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://p-aetech.onrender.com/api';
        
        async function cargarNotaPublica() {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            if(!id) return;

            try {
                const res = await fetch(`${API_BASE_URL}/cuentas/publica/${id}`); 
                if (!res.ok) {
                    document.getElementById('pub-detalle').innerHTML = "<h2>Nota no disponible</h2>";
                    return;
                }

                const c = await res.json();

                // Llenar textos
                document.getElementById('pub-nota-num').innerText = c.numeroNota || "Sin NÃºmero";
                document.getElementById('pub-cliente').innerText = c.clienteNombre;
                document.getElementById('pub-total').innerText = `$${parseFloat(c.total).toFixed(2)}`;
                document.getElementById('pub-anticipo').innerText = `$${parseFloat(c.anticipo).toFixed(2)}`;
                document.getElementById('pub-saldo').innerText = `$${parseFloat(c.saldo).toFixed(2)}`;

                // Render de materiales (Checa que el nombre coincida con tu modelo)
                let htmlMat = '';
                const materiales = c.materiales || []; 
                
                materiales.forEach(m => {
                    htmlMat += `
                        <div style="display:flex; justify-content:space-between; align-items:center; padding: 12px 0; border-bottom: 0.5px solid #eee;">
                            <div style="display:flex; align-items:center; gap:10px;">
                                <img src="${m.fotoUrl || 'img/logoAEtech.png'}" width="40" height="40" style="border-radius:8px; object-fit:cover;">
                                <span><b>${m.cantidad}</b> x ${m.nombre}</span>
                            </div>
                            <b>$${parseFloat(m.costo * m.cantidad).toFixed(2)}</b>
                        </div>`;
                });
                document.getElementById('pub-lista-materiales').innerHTML = htmlMat || "<p>No hay materiales registrados.</p>";

            } catch (e) {
                console.error("Error:", e);
            }
        }
        cargarNotaPublica();
    </script>
</body>
</html>