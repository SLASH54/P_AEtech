<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle de Nota | AEtech</title>
    <link rel="stylesheet" href="cuentas.css"> 

   <style>
    body { 
        background-color: #f2f2f7; 
        font-family: -apple-system, sans-serif; 
        margin: 0; padding: 20px;
        display: flex; justify-content: center;
    }
    .public-card { 
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        width: 100%; max-width: 450px; 
        border-radius: 28px; padding: 30px; 
        box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        border: 1px solid white;
    }
    header { text-align: center; margin-bottom: 25px; }
    h2 { margin: 10px 0 5px; font-size: 22px; color: #000; }
    
    /* Badges de colores iOS */
    .badge-ios {
        padding: 5px 12px; border-radius: 10px; font-size: 11px; font-weight: 700;
    }
    .badge-factura { background: #007aff20; color: #007aff; }
    .badge-iva { background: #34c75920; color: #34c759; }

    /* Materiales */
    .material-item {
        display: flex; justify-content: space-between; align-items: center;
        padding: 12px 0; border-bottom: 0.5px solid #00000010;
    }
    .material-img { width: 45px; height: 45px; border-radius: 10px; object-fit: cover; }

    /* Totales */
    .lev-totales-container {
        background: #00000005; border-radius: 20px; padding: 18px; margin-top: 20px;
    }
    .lev-total-field { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .lev-total-field label { color: #8e8e93; font-size: 14px; }
    .lev-total-field span { font-weight: 600; }



    /* Estilos para el Estatus en la Nota P√∫blica */
.status-badge-public {
    display: inline-block;
    padding: 6px 16px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: bold;
    margin-top: 10px;
    text-transform: uppercase;
}
.status-pagado-public {
    background-color: #34c759; /* Verde iOS */
    color: white;
}
.status-pendiente-public {
    background-color: #ff3b30; /* Rojo iOS */
    color: white;
}


/* Badges de Estatus para Nota P√∫blica */
.pub-status-badge {
    display: inline-block;
    padding: 6px 16px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 13px;
    margin-top: 5px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.pub-status-pagado {
    background-color: #34c75920; /* Verde clarito */
    color: #34c759;             /* Verde fuerte */
    border: 1px solid #34c759;
}

.pub-status-pendiente {
    background-color: #ff3b3020; /* Rojo clarito */
    color: #ff3b30;             /* Rojo fuerte */
    border: 1px solid #ff3b30;
}


</style>
    
</head>
<body>
    <div class="public-card">
        <header style="text-align: center; margin-bottom: 20px; background: transparent;">
            <img src="img/logoAEtech.png" width="80">
            <h2 id="pub-nota-num" style="color: #1c1c1e; margin-top: 10px;">Cargando...</h2>
<div id="pub-status-container"></div>
        </header>

        <div id="pub-detalle">
            <p><strong>Cliente:</strong> <span id="pub-cliente"></span></p>
            <hr style="opacity: 0.1;">
            <div id="pub-lista-materiales"></div>
            
            <div class="lev-totales-container" style="background: rgba(0,0,0,0.03); margin-top: 20px; border-radius: 15px; padding: 15px;">
    
                <div id="pub-badges" style="display: flex; gap: 8px; margin-bottom: 15px;"></div>

                <div class="lev-total-field">
                    <label>Subtotal:</label> 
                    <span id="pub-subtotal"></span>
                </div>

                <div id="row-iva" class="lev-total-field" style="display: none;">
                    <label id="label-iva">IVA (16%):</label> 
                    <span id="pub-iva"></span>
                </div>

                <div class="lev-total-field">
                    <label style="font-weight: 800;">Total:</label> 
                    <span id="pub-total" style="font-weight: 800;"></span>
                </div>

                <div class="lev-total-field">
                    <label style="color: #007aff;">Anticipo:</label> 
                    <span id="pub-anticipo"></span>
                </div>

                <div class="lev-total-field">
                    <label style="color: #ff3b30; font-weight: 800;">Saldo Pendiente:</label> 
                    <span id="pub-saldo" style="font-weight: 800; color: #ff3b30;"></span>
                </div>
            </div>
        </div>
    </div>
<script>
    const API_BASE_URL = 'https://p-aetech.onrender.com/api';
    
    async function cargarNotaPublica() {
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');
        if(!id) return;

        try {
            const res = await fetch(`${API_BASE_URL}/cuentas/publica/${id}`); 
            if (!res.ok) {
                document.getElementById('pub-detalle').innerHTML = "<h2>Nota no disponible</h2>";
                return;
            }

            const c = await res.json();


            // --- L√≥gica de Estatus Din√°mico (Basado en saldo y estatus) ---
const containerEstatus = document.getElementById('pub-status-container');
const saldoNum = parseFloat(c.saldo) || 0;
const estatusOriginal = c.estatus;

// Si el saldo es 0 o menos, o el estatus ya dice Pagado
const esPagado = (saldoNum <= 0 || estatusOriginal === 'Pagado');

if (containerEstatus) {
    if (esPagado) {
        containerEstatus.innerHTML = `<span class="pub-status-badge pub-status-pagado">PAGADO</span>`;
    } else {
        containerEstatus.innerHTML = `<span class="pub-status-badge pub-status-pendiente">PENDIENTE</span>`;
    }
}

            // 1. Manejo de Badges (Factura y IVA) - Usando clases CSS iOS
            let badgesHtml = '';
            if (c.factura) {
                badgesHtml += `<span class="badge-ios badge-factura">üìù REQUIERE FACTURA</span> `;
            }
            if (c.iva) {
                badgesHtml += `<span class="badge-ios badge-iva">‚ûï IVA INCLUIDO</span>`;
            }
            document.getElementById('pub-badges').innerHTML = badgesHtml;

            // 2. L√≥gica de Totales (Mantenemos tus c√°lculos exactos)
            const total = parseFloat(c.total) || 0;
            const anticipo = parseFloat(c.anticipo) || 0;
            const saldo = parseFloat(c.saldo) || 0;

            if (c.iva) {
                const porcentaje = c.ivaPorcentaje || 16;
                const subtotal = total / (1 + (porcentaje / 100));
                const montoIva = total - subtotal;

                if(document.getElementById('row-iva')){
                    document.getElementById('row-iva').style.display = 'flex';
                    document.getElementById('label-iva').innerText = `IVA (${porcentaje}%):`;
                    document.getElementById('pub-subtotal').innerText = `$${subtotal.toFixed(2)}`;
                    document.getElementById('pub-iva').innerText = `$${montoIva.toFixed(2)}`;
                }
            } else {
                if(document.getElementById('pub-subtotal')) 
                    document.getElementById('pub-subtotal').innerText = `$${total.toFixed(2)}`;
                if(document.getElementById('row-iva')) 
                    document.getElementById('row-iva').style.display = 'none';
            }

            // Llenar Totales Principales
            document.getElementById('pub-total').innerText = `$${total.toFixed(2)}`;
            document.getElementById('pub-anticipo').innerText = `$${anticipo.toFixed(2)}`;
            document.getElementById('pub-saldo').innerText = `$${saldo.toFixed(2)}`;

            // 3. Llenar Informaci√≥n de Cabecera
            document.getElementById('pub-nota-num').innerText = c.numeroNota || "Sin N√∫mero";
            document.getElementById('pub-cliente').innerText = c.clienteNombre;
            
            // Si tiene folio de factura, lo agregamos abajito del nombre
            if(c.factura && c.folioFactura) {
                document.getElementById('pub-cliente').innerHTML += `<br><small style="color:#8e8e93; font-weight:normal;">Folio Factura: ${c.folioFactura}</small>`;
            }

            // 4. Render de materiales con el estilo chido
            let htmlMat = '';
            const materiales = c.materiales || []; 
            
            materiales.forEach(m => {
                // Si no hay foto, usamos el logo de la empresa
                const fotoAMostrar = m.fotoUrl && m.fotoUrl !== "" ? m.fotoUrl : 'img/logoAEtech.png';
                
                htmlMat += `
                    <div class="material-item">
                        <div style="display:flex; align-items:center; gap:12px;">
                            <img src="${fotoAMostrar}" class="material-img">
                            <div style="display:flex; flex-direction:column;">
                                <span style="font-weight:600; color:#1c1c1e;">${m.nombre}</span>
                                <span style="font-size:12px; color:#8e8e93;">Cantidad: ${m.cantidad}</span>
                            </div>
                        </div>
                        <b style="color:#1c1c1e;">$${parseFloat(m.costo * m.cantidad).toFixed(2)}</b>
                    </div>`;
            });
            document.getElementById('pub-lista-materiales').innerHTML = htmlMat || "<p style='text-align:center; color:gray;'>No hay materiales registrados.</p>";

        } catch (e) {
            console.error("Error al cargar la nota:", e);
            document.getElementById('pub-detalle').innerHTML = "<h2>Error al conectar con el servidor</h2>";
        }




    }

    // Ejecutar carga
    cargarNotaPublica();
</script>

</body>
</html>