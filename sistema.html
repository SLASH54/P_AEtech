<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AETech App</title>

    <link rel="stylesheet" href="login.css">
    <link rel="icon" href="img/logoAEtech.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Los estilos CSS se encuentran en el archivo login.css */
        
    </style>
</head>
<body>

    <!-- üîπ Pantalla de carga -->
<div id="loader" class="loader-overlay" style="display: none;">
  <div class="loader-container">
    <div class="spinner"></div>
    <p>Procesando, por favor espera...</p>
  </div>
</div>


    <div class="container">
        <header>
            <img src="img/logoAEtech.png" width="80px" height="80px">
                         <section class="login-section">
    <div class="login-menu">
    
    <!-- üîî BOT√ìN DE NOTIFICACIONES -->
    <div class="notificaciones-container">
        <button id="btnNotificaciones" class="notif-btn" aria-label="Notificaciones">
            üîî <span id="numNotificaciones">0</span>
        </button>
        <ul id="listaNotificaciones" class="notificaciones-lista"></ul>
    </div>

    <!-- üë§ BOT√ìN DE PERFIL -->
    <button id="login-button" aria-label="Perfil de usuario">
        <i class="fas fa-user-circle"></i>
    </button>

    <div class="dropdown-menu" id="dropdown-menu">
        <!-- Informaci√≥n del perfil -->
        <div class="profile-info" id="profile-info">
            <img src="img/perfil.jpg" alt="perfil.jpg" class="profile-image">
            <p class="profile-name">Nombre del Usuario</p>
            <p class="profile-email">usuario@email.com</p>
        </div>
        <!-- Bot√≥n de cerrar sesi√≥n -->
        <button id="logout-button" onclick="logout('logout-button')">Cerrar Sesi√≥n</button>
    </div>
</div>


    <script>
        const loginButton = document.getElementById('login-button');
        const dropdownMenu = document.getElementById('dropdown-menu');
        const profileInfo = document.getElementById('profile-info');
        const logoutButton = document.getElementById('logout-button');

        // Oculta el men√∫ desplegable al principio
        dropdownMenu.style.display = 'none';

        loginButton.addEventListener('click', (event) => {
            event.stopPropagation(); // Evita que el clic se propague
            // Muestra u oculta el men√∫ al hacer clic en el icono
            if (dropdownMenu.style.display === 'none') {
                dropdownMenu.style.display = 'block';
            } else {
                dropdownMenu.style.display = 'none';
            }
        });

        // Cierra el men√∫ si se hace clic fuera de √©l
        document.addEventListener('click', (event) => {
            if (!loginButton.contains(event.target) && !dropdownMenu.contains(event.target)) {
                dropdownMenu.style.display = 'none';
            }
        });

        

        // Funci√≥n para actualizar la informaci√≥n del perfil (ejemplo)
        function updateProfileInfo(name, email, image) {
            document.querySelector('.profile-name').textContent = name;
            document.querySelector('.profile-email').textContent = email;
            document.querySelector('.profile-image').src = image;
        }

        
    </script>
</section>


            
        </header>

    <nav class="sidebar-nav">
        <button class="menu-toggle" onclick="toggleMenu()">
            &#9776; 
        </button>

        <ul id="main-menu">
            <li><button onclick="mostrarContenido('Tablero')">Tablero</button></li>
            <li><button onclick="mostrarContenido('organizador-tareas')">Tareas</button></li>
          <li><button onclick="mostrarContenido('listaLevantamientos')">Levantamientos</button></li>


           
            <li><button onclick="mostrarContenido('Sucursales')">Sucursales</button></li>
           
            <li><button onclick="mostrarContenido('Administracion')">Personal</button></li>
            <li><button onclick="mostrarContenido('Clientes')">Clientes</button></li>
    ¬†¬†¬†¬†</ul>
    </nav>
        <main>



            
    <section id="Evidencia" class="main-content ">
                
    </section>



        <section id="Tablero" class="main-content">

  <div class="tablero-container">
   <div class="top-bar">
    <div class="social-icons">
     <a href="https://wa.me/2212724031" target="_blank" dm_dont_rewrite_url="true" aria-label="whatsapp" onclick="dm_gaq_push_event &amp; dm_gaq_push_event('socialLink', 'click', 'Whatsapp')"> <span class="dmSocialWhatsapp dm-social-icons-whatsapp oneIcon socialHubIcon style6" aria-hidden="true" data-hover-effect="float" class="social-icon"><img src="img/whatsapp.jpg" alt="whatsapp.jpg"></a></span>
     <a href="https://facebook.com/AETech18" target="_blank" dm_dont_rewrite_url="true" aria-label="facebook" onclick="dm_gaq_push_event &amp;  dm_gaq_push_event('socialLink', 'click', 'Facebook')"> <span class="dmSocialFacebook dm-social-icons-facebook oneIcon socialHubIcon style6" aria-hidden="true" data-hover-effect="float" class="social-icon"><img src="img/facebook.jpg" alt="facebook.jpg"></a></span>
     <a href="http://instagram.com/aetech18" target="_blank" dm_dont_rewrite_url="true" aria-label="instagram" onclick="dm_gaq_push_event &amp; dm_gaq_push_event('socialLink', 'click', 'Instagram')"> <span class="dmSocialInstagram dm-social-icons-instagram oneIcon socialHubIcon style6" aria-hidden="true" data-hover-effect="float" class="social-icon"><img src="img/instagram.jpg" alt="instagram.jpg"></a></span>
     <a href="mailto:contacto@aetech.com.mx" dm_dont_rewrite_url="true" aria-label="email" onclick="dm_gaq_push_event &amp; dm_gaq_push_event('socialLink', 'click', 'Email')" target="_blank"> <span class="dmSocialEmail dm-social-icons-email oneIcon socialHubIcon style6" aria-hidden="true" data-hover-effect="float" class="social-icon"><img src="img/gmail.jpg" alt="gmail.jpg"></a></span>
    </div>
    
    
     <img src="img/imgae.jpg" alt="imgae.jpg">
     


    <div class="contact-info">
     <i class="fas fa-phone"></i> <a class="u_1788509405 default dmDefaultGradient align-center dmCall voipReplacement dmWidget dmNoMark dmWwr" contenteditable="false" onclick=";return dm_gaq_push_event('ClickToCall', 'Call',null,'4f1868a89c9c49a1800af08875200556', this);" id="1788509405" dmle_extension="clicktocall" data-element-type="clicktocall" data-buttonstyle="FLAT_ROUND_ICON" wr="true" data-display-type="block" localization_key_description="googleTranslate.HLc6QEJ.39" icon="true" surround="true" description="Llama ahora" adwords="" icon-name="icon-phone" phone="222 143 4363" text="" image="" target="_blank"> <span class="iconBg" aria-hidden="true"></a> 
     <a class="default dmDefaultGradient align-center dmCall voipReplacement dmWidget dmNoMark dmWwr" href="tel:222 143 4363" contenteditable="false" onclick=";return dm_gaq_push_event('ClickToCall', 'Call',null,'4f1868a89c9c49a1800af08875200556', this);" id="1302615267" dmle_extension="clicktocall" data-element-type="clicktocall" wr="true" data-display-type="block" localization_key_description="googleTranslate.oJ4SyII.32" icon="true" surround="true" description="Llamar" adwords="" icon-name="icon-phone" phone="222 143 4363" text="" image="" target="_blank"> <span class="iconBg" aria-hidden="true"> <span class="icon hasFontIcon icon-phone"></span> 
        </span> 
        <span class="text">Llama ahora</span> 
        <span class="text phoneNumHolder">222 143 4363</span>
     </a>
    </div>
   </div>
   
   
  <section id="TableroAetech" class="tablero-aetech">
    <div class="quick-actions">
    <div class="qa-card" onclick="mostrarContenido('organizador-tareas')">
        üìù <span>Tareas</span>
    </div>

    <div class="qa-card" onclick="mostrarContenido('Clientes')">
        üë• <span>Clientes</span>
    </div>

    <div class="qa-card" onclick="mostrarContenido('listaLevantamientos')">
    üìã <span>Levantamientos</span>
</div>

    

    <div class="qa-card" onclick="mostrarContenido('Administracion')">
        üë§ <span>Personal</span>
    </div>
</div>
  <div class="dashboard-card">
    <h2>üëã ¬°Hola, <span id="nombreUsuario"></span>!</h2>
    <p id="fraseDia">"La tecnolog√≠a es mejor cuando une a las personas."</p>
    <div class="info-extra">
      <p>üïí <span id="horaActual"></span></p>
      <p>üìÖ <span id="fechaActual"></span></p>
      <p>üå§Ô∏è <span id="climaActual">Cargando clima...</span></p>
    </div>
  </div>
</section>

 



   <div class="main-content-area">
    <img id="logo-animado" src="img/logoNavidad.png" alt="logo.jpg" class="logo.jpg">

    <div class="viva-mexico">
     <span class="viva">Feliz</span>
     <span class="mexico">Navidad</span>
    </div>

   

   <div class="bottom-bar">
    <p>¬© 2025 AE Tech. Todos los derechos reservados.</p>
   </div>
  </div>
     
            </section>


         <!-- NUEVO CONTENEDOR ORGANIZADOR DE TAREAS -->
<!-- Secci√≥n de Tareas -->
<section id="organizador-tareas" class="main-content">
    <div class="p-8">
        <h2 class="text-3xl font-bold mb-6 text-gray-800 border-b pb-2">Organizador de Tareas</h2>

        <div class="flex justify-between items-center mb-6">
            <p class="text-gray-600">Gesti√≥n centralizada de las tareas asignadas y sus estados.</p>
            <button id="openAddTaskModal" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 transform hover:scale-105">
                + Nueva Tarea
            </button>
        </div>

        <!-- Aqu√≠ se mover√° el contenedor de la tabla -->

    </div>

    <div id="filtrosTareas"
     style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:20px; width:100%;">
    
    <select id="filterCliente" class="form-control">
        <option value="">Todos los clientes</option>
    </select>

    <select id="filterActividad" class="form-control">
        <option value="">Todas las actividades</option>
    </select>


    <button id="btnLimpiarFiltros"
        style="padding:6px 14px; border-radius:6px; background:#850f0f;
               border:1px solid #850f0f; cursor:pointer; height:32px;">
        Limpiar
    </button>
</div>




    <!-- Contenedor de la tabla (MOVIDO AQU√ç) -->
    <div class="bg-white shadow-xl rounded-xl overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200" id="tareasTable">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">T√≠tulo</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asignado a</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Direccion</th>
                     <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha L√≠mite</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200" id="tareasBody">
                <!-- Aqu√≠ se cargar√°n las tareas con JavaScript -->
                <tr>
                    <td colspan="6" class="p-4 text-center text-gray-500">Cargando tareas...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- MODAL para Agregar/Editar Tarea -->
    <div id="tareaModal"
        class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6">
            <h3 id="tareaModalTitle" class="text-2xl font-semibold mb-4 border-b pb-2">Crear Nueva Tarea</h3>
            <form id="tareaForm">
                <input type="hidden" id="tareaId">

                <div class="mb-4">
                    <label for="tareaTitulo" class="block text-sm font-medium text-gray-700">T√≠tulo</label>
                    <input type="text" id="tareaTitulo" name="titulo" required
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                        
                </div>

                <div class="mb-4">
                    <label for="tareaDescripcion" class="block text-sm font-medium text-gray-700">Descripci√≥n</label>
                    <textarea id="tareaDescripcion" name="descripcion" required rows="3"
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="tareaAsignadoA" class="block text-sm font-medium text-gray-700">Asignar a
                            Usuario</label>

                        <select id="tareaAsignadoA" name="asignadoA" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="" disabled selected>-- Seleccione Usuario --</option>
                            <!-- Opciones cargadas din√°micamente -->
                        </select>
                    </div>
                    <div>
                        <label for="tareaClienteId" class="block text-sm font-medium text-gray-700">Cliente
                            Asociado</label>
                        <select id="tareaClienteId" name="clienteId" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="" disabled selected>-- Seleccione Cliente --</option>
                        </select>
                    </div>
                    <div>
                        <label for="tareaFechaLimite" class="block text-sm font-medium text-gray-700">Fecha
                            L√≠mite</label>
                        <input type="date" id="tareaFechaLimite" name="fechaLimite" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>

                <div class="mb-4">
    <label for="tareaDireccionCliente" class="block text-sm font-medium text-gray-700">
        Direcci√≥n del Cliente
    </label>

    <select id="tareaDireccionCliente" name="direccionCliente"
        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
        <option value="">-- Seleccione Direcci√≥n --</option>
    </select>
</div>


                <div class="mb-4">
                    <label for="tareaActividadId" class="block text-sm font-medium text-gray-700">Tipo de
                        Actividad</label>
                    <select id="tareaActividadId" name="actividad" required
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="" disabled selected>-- Seleccione Actividad --</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label for="tareaEstado" class="block text-sm font-medium text-gray-700">Estado</label>
                    <select id="tareaEstado" name="estado" required
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="Pendiente">Pendiente</option>
                        <option value="En Progreso">En Progreso</option>
                        <option value="Completada">Completada</option>
                        <option value="Bloqueada">Bloqueada</option>
                    </select>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="closeTareaModal"
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-300">
                        Cancelar
                    </button>
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">
                        Guardar Tarea
                    </button>
                </div>
            </form>
        </div>
    </div>
</section>

            
     








            <section id="Sucursales" class="main-content">
    <h2>Sucursales</h2>
    <div class="contenedor-tarjetas">

        <!-- Tarjetas de Sucursales  -->
        <div class="tarjeta">
            <div class="map-container">
                <h3>Sucursal Atlixco</h3>
                <p>Calzada Oaxaca #3112, segundo piso, Francisco I. Madero, Atlixco, Puebla</p>
                <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3771.471895372691!2d-98.2224834!3d19.042978899999998!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x85cfc7032f95847f%3A0x14368cb67647d37!2sAE%20TECH!5e0!3m2!1ses!2smx!4v1759351519212!5m2!1ses!2smx"
                    width="600" height="450" style="border:0;" allowfullscreen="" loading="lazy"
                    referrerpolicy="no-referrer-when-downgrade"></iframe>
            </div>
        </div>

        <div class="tarjeta">
            <div class="map-container">
                <h3>Punto de Venta Atlixco</h3>
                <p>Calle 15 Poniente #107, Alvaro Obregon, Atlixco, Puebla</p>
                <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3774.9294048160427!2d-98.43886917431595!3d18.89021274801054!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x85cfb3b2f3c72c4b%3A0x7997679f2d024d6e!2sAE%20TECH!5e0!3m2!1ses!2smx!4v1759349314481!5m2!1ses!2smx"
                    width="600" height="450" style="border:0;" allowfullscreen="" loading="lazy"
                    referrerpolicy="no-referrer-when-downgrade"></iframe>
            </div>
        </div>

        <div class="tarjeta">
            <div class="map-container">
                <h3>Sucursal Puebla</h3>
                <p>Calle 25 Sur #2710, Benito Juarez, Puebla, Puebla</p>
                <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3774.670411065148!2d-98.43769879999999!3d18.9016973!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x85cfb47f9d4aa489%3A0xecab6b4b061b7393!2sAE%20TECH!5e0!3m2!1ses!2smx!4v1759350362434!5m2!1ses!2smx"
                    width="600" height="450" style="border:0;" allowfullscreen="" loading="lazy"
                    referrerpolicy="no-referrer-when-downgrade"></iframe>
            </div>
        </div>
</section>
</section>


<section id="agregar-comentario" class="main-content">
    <h2>Agregar Comentario</h2>
    <form id="form-comentario">
        <div class="form-group">
            <label for="comentario">Comentario:</label>
            <textarea id="comentario" name="comentario" rows="4" required></textarea>
        </div>
        <div class="form-group">
            <label>Calificaci√≥n:</label>
            <div class="rating">
                <span class="star" data-rating="1">&#9733;</span>
                <span class="star" data-rating="2">&#9733;</span>
                <span class="star" data-rating="3">&#9733;</span>
                <span class="star" data-rating="4">&#9733;</span>
                <span class="star" data-rating="5">&#9733;</span>
                <input type="hidden" id="rating-value" name="rating" value="0">
            </div>
        </div>
        <button type="submit">Publicar Comentario</button>
        <button type="button" id="btn-cancelar-comentario">Cancelar</button>
    </form>

    <section id="lista-comentarios" style="display: none;">
        <h2>Comentarios</h2>
        <!-- Aqu√≠ se mostrar√°n los comentarios -->
        <!-- Ejemplo de un comentario -->
        <div class="comentario">
            <div class="comentario-header">
                <img src="img/default-user.png" alt="Avatar" class="comentario-avatar">
                <div class="comentario-info">
                    <span class="comentario-autor">Nombre del Autor</span>
                    <div class="comentario-calificacion">
                        <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i
                            class="fas fa-star"></i><i class="far fa-star"></i>
                    </div>
                </div>
            </div>
            <p class="comentario-texto">Este es un ejemplo de comentario. ¬°El servicio fue excelente!</p>
        </div>
        <!-- Fin del ejemplo de comentario -->
    </section>
</section>

<script>
            // Funci√≥n para alternar la visibilidad del men√∫
        function toggleUserMenu() {
            const menu = document.getElementById('user-dropdown-menu');
            menu.classList.toggle('show');
        }

        // Funci√≥n para cargar los datos en el men√∫ al iniciar la p√°gina
        function loadUserInfo() {
            const name = localStorage.getItem('userName') || 'Usuario';
            const email = localStorage.getItem('userEmail') || 'No logeado';

            document.getElementById('menu-user-name').textContent = name;
            document.getElementById('menu-user-email').textContent = email;
        }

    document.addEventListener('DOMContentLoaded', function () {
        const agregarComentarioSection = document.getElementById('agregar-comentario');
        const formComentario = document.getElementById('form-comentario');
        const listaComentarios = document.getElementById('lista-comentarios');
        const btnCancelarComentario = document.getElementById('btn-cancelar-comentario');
        const stars = document.querySelectorAll('.star');
        const ratingValueInput = document.getElementById('rating-value');
        const profileButton = document.getElementById('user-profile-btn');
        const logoutMenuButton = document.getElementById('menu-logout-btn');

    if (profileButton && logoutMenuButton) {
        // 1. Conecta el bot√≥n de perfil para abrir/cerrar el men√∫
        profileButton.addEventListener('click', toggleUserMenu);
        
        // 2. Conecta el bot√≥n de cerrar sesi√≥n del men√∫
        logoutMenuButton.addEventListener('click', logout);
        
        // 3. Carga los datos del usuario
        loadUserInfo();
    }


        // Ocultar la secci√≥n de comentarios al cargar la p√°gina
        listaComentarios.style.display = 'none';

        // Cancelar la creaci√≥n del comentario
        btnCancelarComentario.addEventListener('click', function () {
            document.getElementById('comentario').value = '';
            ratingValueInput.value = "0";
            stars.forEach(star => star.classList.remove('selected'));
            
        });

        // Publicar el comentario
        formComentario.addEventListener('submit', function (event) {
            event.preventDefault();

            const comentario = document.getElementById('comentario').value;
            const ratingValue = ratingValueInput.value;

            if (!comentario || ratingValue === "0") {
                alert('Por favor, ingrese un comentario y seleccione una calificaci√≥n.');
                return;
            }

            // Crear el elemento del comentario
            const nuevoComentario = document.createElement('div');
            nuevoComentario.classList.add('comentario');
            nuevoComentario.innerHTML = `
                <div class="comentario-header">
                    <img src="img/default-user.png" alt="Avatar" class="comentario-avatar">
                    <div class="comentario-info">
                        <span class="comentario-autor">An√≥nimo</span>
                        <div class="comentario-calificacion">
                            ${generarEstrellas(ratingValue)}
                        </div>
                    </div>
                </div>
                <p class="comentario-texto">${comentario}</p>
            `;

            listaComentarios.appendChild(nuevoComentario);

            // Limpiar el formulario
            document.getElementById('comentario').value = '';
            ratingValueInput.value = "0"; // Reset rating value
            stars.forEach(star => star.classList.remove('selected')); // Remove selected class

            listaComentarios.style.display = 'block'; // Mostrar la lista de comentarios al publicar
        });

        // Funci√≥n para generar las estrellas seg√∫n la calificaci√≥n
        function generarEstrellas(rating) {
            let estrellas = '';
            for (let i = 0; i < rating; i++) {
                estrellas += '<i class="fas fa-star"></i>';
            }
            for (let i = rating; i < 5; i++) {
                estrellas += '<i class="far fa-star"></i>';
            }
            return estrellas;
        }

        // Star rating functionality
        stars.forEach(star => {
            star.addEventListener('click', function () {
                const rating = this.dataset.rating;
                ratingValueInput.value = rating;

                // Highlight selected stars
                stars.forEach(star => star.classList.remove('selected'));
                for (let i = 0; i < rating; i++) {
                    stars[i].classList.add('selected');
                }
            });
        });
    });
</script>


<section id="Administracion" class="main-content">
    <h2>Administraci√≥n de Usuarios</h2>

    <h3>Usuarios con Roles</h3>
    <div class="datagrid-container">
        <table id="datagridUsuariosRoles">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Email</th>
                    <th>Rol</th>
                    <th>Contrase√±a</th>
                    <th>Acciones</th> </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>

</section>


<section id="Clientes" class="main-content">
    <h3>Clientes</h3>
    <button id="btnIrFormularioCliente" class="glass-btn-ios">
    <span class="glass-text">+ Agregar Cliente</span>
    <span class="shine"></span>
</button>

    <div class="datagrid-container">
        <table id="datagridClientes">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Email</th>
                    <th>Direcci√≥n</th> 
                    <th>Tel√©fono</th>
                    <th>Acciones</th> </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>
  <div class="form-container">
    <div class="logo-container">
      <img src="img/logoAEtech.png" alt="logoAEtech">
    </div>

    <form id="registroClienteForm"> 
      <div class="form-group">
        <label for="client-nombre">Nombre:</label>
        <input type="text" id="client-nombre" name="nombre" required> 
      </div>

      <div class="form-group">
        <label for="client-email">Email (opcional):</label>
        <input type="email" id="client-email" name="email" placeholder="Ej. usuario@correo.com">
      </div>

      <div class="form-group">
        <label for="client-telefono">Tel√©fono:</label>
        <input type="text" id="client-telefono" name="telefono" placeholder="Ej. 2441234567" required> 
      </div>

      <div class="form-group">
        <label for="client-estado">Estado:</label>
        <select id="client-estado" name="estado">
          <option value="">Selecciona un estado</option>
          <option value="Aguascalientes">Aguascalientes</option>
          <option value="Baja California">Baja California</option>
          <option value="Baja California Sur">Baja California Sur</option>
          <option value="Campeche">Campeche</option>
          <option value="Chiapas">Chiapas</option>
          <option value="Chihuahua">Chihuahua</option>
          <option value="Ciudad de M√©xico">Ciudad de M√©xico</option>
          <option value="Coahuila">Coahuila</option>
          <option value="Colima">Colima</option>
          <option value="Durango">Durango</option>
          <option value="Estado de M√©xico">Estado de M√©xico</option>
          <option value="Guanajuato">Guanajuato</option>
          <option value="Guerrero">Guerrero</option>
          <option value="Hidalgo">Hidalgo</option>
          <option value="Jalisco">Jalisco</option>
          <option value="Michoac√°n">Michoac√°n</option>
          <option value="Morelos">Morelos</option>
          <option value="Nayarit">Nayarit</option>
          <option value="Nuevo Le√≥n">Nuevo Le√≥n</option>
          <option value="Oaxaca">Oaxaca</option>
          <option value="Puebla">Puebla</option>
          <option value="Quer√©taro">Quer√©taro</option>
          <option value="Quintana Roo">Quintana Roo</option>
          <option value="San Luis Potos√≠">San Luis Potos√≠</option>
          <option value="Sinaloa">Sinaloa</option>
          <option value="Sonora">Sonora</option>
          <option value="Tabasco">Tabasco</option>
          <option value="Tamaulipas">Tamaulipas</option>
          <option value="Tlaxcala">Tlaxcala</option>
          <option value="Veracruz">Veracruz</option>
          <option value="Yucat√°n">Yucat√°n</option>
          <option value="Zacatecas">Zacatecas</option>
        </select>
      </div>

      <div class="form-group">
        <label for="client-municipio">Municipio:</label>
        <input type="text" id="client-municipio" name="municipio" placeholder="Ej. Atlixco">
      </div>

      <!-- CONTENEDOR PRINCIPAL DE DIRECCIONES -->
    <div class="form-group">
        <label>Direcciones del Cliente:</label>

        <div id="direccionesContainerRegistro">
        <div class="direccion-item">
            <input
            type="text"
            name="alias[]"
            placeholder="Alias (opcional) ej. Sucursal Centro"
            class="input-alias"
            />
            
            <input
            type="text"
            name="direccion[]"
            placeholder="Ej. Calle 10 Sur #123 o link Google Maps"
            required
            />

            <button type="button" class="btn-remove-dir"
            onclick="this.parentElement.remove()">
            Eliminar
            </button>
        </div>
        </div>


        <button type="button" id="btnAgregarDireccionRegistro" class="btn-add-dir">
            + Agregar otra direcci√≥n
        </button>
    </div>


      <button type="submit">Registrar Cliente</button>
    </form>
  </div>
  
</section>








<section id="Actividades" class="main-content">
  <h2 class="titulo-seccion">üì∏ Registro de Evidencias</h2>

  <div id="contenedor-evidencias" class="evidencias-grid">

    <!-- Campo 1 -->
    <div class="card-evidencia">
      <label>T√≠tulo de la evidencia</label>
      <input type="text" name="titulo[]" placeholder="Ej: Foto antes de la instalaci√≥n">
      <!-- PREVISUALIZACI√ìN DE IMAGEN -->
<div class="preview-container">
  <img class="preview-img" src="" alt="Vista previa" style="display:none;">
</div>

      <label class="label-file">
        <i class="fa-solid fa-camera"></i> Tomar Foto / Elegir Archivo
        <input type="file" name="archivos" class="archivo" accept="image/*">
      </label>
    </div>

    <!-- Campo 2 -->
    <div class="card-evidencia">
      <label>T√≠tulo de la evidencia</label>
      <input type="text" name="titulo[]" placeholder="Ej: Foto despu√©s de la instalaci√≥n">
      <!-- PREVISUALIZACI√ìN DE IMAGEN -->
<div class="preview-container">
  <img class="preview-img" src="" alt="Vista previa" style="display:none;">
</div>

      <label class="label-file">
        <i class="fa-solid fa-camera"></i> Tomar Foto / Elegir Archivo
        <input type="file" name="archivos" class="archivo" accept="image/*">
      </label>
    </div>
  </div>

  <!-- FIRMA DEL CLIENTE -->
    <section id="firma-cliente" class="firma-section">
    <h2>üñäÔ∏è Firma del Cliente</h2>
    <canvas id="signature-pad" width="400" height="200"></canvas>
    <div class="firma-botones">
        <button type="button" id="btnLimpiarFirma">
        <i class="fa-solid fa-eraser"></i> Limpiar
        </button>
        <button type="button" id="btnGuardarFirma">
        <i class="fa-solid fa-floppy-disk"></i> Guardar Firma
        </button>
    </div>
    </section>
  <div class="botones-evidencias">
    <button type="button" id="btnAgregarFoto">
      <i class="fa-solid fa-plus"></i> Agregar Foto Adicional
    </button>


    <button type="button" id="btnGuardarEvidencias">
      <i class="fa-solid fa-floppy-disk"></i> Guardar Evidencias
    </button>
  </div>
</section>

  <div id="editModal" class="modal">
  <div class="modal-content">
    <span class="close-button" onclick="closeModal('editModal')">&times;</span>
    <h3>Editar Registro (<span id="recordType"></span>)</h3>

    <form id="editForm">
      <input type="hidden" id="edit-id" name="id">
      <input type="hidden" id="edit-type" name="type">

      <label for="edit-nombre">Nombre:</label>
      <input type="text" id="edit-nombre" name="nombre" required>

      <label for="edit-email">Email:</label>
      <input type="email" id="edit-email" name="email">

      <!-- CAMPOS SOLO PARA USUARIOS -->
      <div id="userFields" style="display:none;">
        <label for="edit-rol">Rol:</label>
        <select id="edit-rol" name="rol">
          <option value="" disabled selected>-- Selecciona un rol --</option>
          <option value="Admin">Admin</option>
          <option value="Ingeniero">Ingeniero</option>
          <option value="Residente">Residente</option>
          <option value="Practicante">Practicante</option>
        </select>
      </div>

      <!-- CAMPOS SOLO PARA CLIENTE -->
      <div id="clientFields" style="display:none;">
        <label for="edit-telefono">Tel√©fono:</label>
        <input type="text" id="edit-telefono" name="telefono">

        <label for="">Direcciones del Cliente:</label>

        <div id="direccionesContainer"></div>

        <button type="button" onclick="agregarDireccion()" class="btn-add-dir">
          + Agregar direcci√≥n
        </button>
      </div>

      <button type="submit" class="btn-save">Guardar Cambios</button>
    </form>
  </div>
</div>
   
    <script>



        // Funci√≥n para mostrar el contenido de una secci√≥n y ocultar las dem√°s
        

        function toggleEvaluacion(element) {
            let detalles = element.parentNode.nextElementSibling;
            if (detalles.style.display === "none") {
                detalles.style.display = "block";
                element.innerHTML = '<i class="fas fa-chevron-up"></i>';
            } else {
                detalles.style.display = "none";
                element.innerHTML = '<i class="fas fa-chevron-down"></i>';
            }
        }

        // --- L√≥gica de inicializaci√≥n y actualizaci√≥n ---
        document.addEventListener('DOMContentLoaded', () => {
            // Mostrar la secci√≥n de Evidencias por defecto al cargar la p√°gina
            mostrarContenido('Tablero');
            checkSession();
            

        const registroClienteForm = document.getElementById('registroClienteForm');
            if(registroClienteForm) {
                registroClienteForm.addEventListener('submit', registerClient);
            }
        
            // üîë LLAMAR A LA RESTRICCI√ìN AQU√ç üîë
        restrictAdminSection();
        });

        //Cerrar Sesion
        document.getElementById('logout-button').addEventListener('click', logout);

       

    </script>
    
        <!-- Firebase (Compat para FCM en web + SW) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging-compat.js"></script>

    <!-- Tu configuraci√≥n (rellena con tus valores reales) -->
    <script>
    window.FB_CONFIG = {
        apiKey: "AIzaSyBa6KYyhwI4scIblnOY_VKb-1kSwwO9_Ts",
        authDomain: "aetech-notificaciones.firebaseapp.com",
        projectId: "aetech-notificaciones",
        storageBucket: "aetech-notificaciones.firebasestorage.app",
        messagingSenderId: "742322294289",
        appId: "1:742322294289:web:5bd9e894ad92dbef4dabb0",
        vapidKey: "BOTEAlz-7hYedgFy9YSbo3txG_14XJaf0tt4qCCwS3ifs67umn8UDn5fLirfmTmSh17P5r_cUMhrL8uDnZsiWys" // la que te dio Cloud Messaging
    };
    </script>



    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script src="script.js"></script>

    <!-- MODAL PARA VISUALIZAR EVIDENCIAS -->
<div id="modalEvidencias" class="modal">
  <div class="modal-content">
    <span class="close" onclick="cerrarModalEvidencias()">&times;</span>
    <h2>üì∏ Evidencias</h2>

    <div id="contenedorEvidencias"></div>

    <!-- üîπ Bot√≥n de descarga -->
    <button id="btnDescargarEvidencias" class="btn-descargar" onclick="descargarEvidencias()">
      ‚¨áÔ∏è Descargar todas
    </button>
  </div>
</div>



<!-- ========== LISTA DE LEVANTAMIENTOS ========== -->
<div id="listaLevantamientos" class="main-content show">

    <div class="tareas-container">

        <h2 class="section-title">Organizador de Levantamientos</h2>

        <!-- BOT√ìN NUEVO -->
      <button id="btnNuevoLevantamiento"
        class="btn btn-primary"
        style="margin-bottom: 15px;">
    + Nuevo Levantamiento
</button>



        <!-- TABLA -->
        <div class="table-responsive" style="margin-top: 15px;">
          <table class="tabla">
  <thead>
    <tr>
      <th>Cliente</th>
      <th>Direcci√≥n</th>
      <th>Personal</th>
      <th>Fecha</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody id="tablaLevantamientos"></tbody>
</table>

        </div>

    </div>

</div>


<!-- ========== MODAL NUEVO LEVANTAMIENTO (iOS Style) ========== -->
<!-- ========== MODAL NUEVO LEVANTAMIENTO (iOS / Glass) ========== -->
<div id="modalNuevoLevantamiento" class="modalGlass">
    <div class="modalGlass-content">

        <h2 class="modalGlass-title">Nuevo Levantamiento</h2>
        <span class="modalGlass-close" onclick="closeNuevoLevantamiento()">‚úñ</span>
<div class="lev-form-grid">

    <div class="lev-field">
        <label>Cliente</label>
        <select id="lev-clienteSelect"></select>
    </div>

    <div class="lev-field">
        <label>Direcci√≥n</label>
        <input id="lev-direccion" type="text">
    </div>

    <div class="lev-field">
        <label>Personal</label>
        <input id="lev-personal" type="text" readonly>
    </div>

    <div class="lev-field">
        <label>Fecha y Hora</label>
        <input id="lev-fechaHora" type="datetime-local">
    </div>

</div>

        <!-- NECESIDADES -->
        <h4>Necesidades:</h4>
        <div id="lev-necesidadesContainer"></div>
        <button id="btnAddNecesidad" class="btn btn-secondary" type="button">+ Agregar</button>

        <hr>

        <!-- MATERIALES -->
       <h4>Materiales:</h4>

<div class="lev-material-container">
    <select id="levInsumo" onchange="levMostrarCampoExtra()">
        <option value="" disabled selected>Seleccione un insumo</option>

        <optgroup label="Cable">
            <option value="Cable">Cable</option>
        </optgroup>

        <optgroup label="Transceptor">
            <option value="Transceptor">Transceptor</option>
        </optgroup>

        <optgroup label="Conectores">
            <option value="Conector de corriente">Conector de corriente</option>
        </optgroup>

        <optgroup label="Fuente de poder 12V">
            <option value="12vdc 1A">12vdc 1A</option>
            <option value="12vdc 1.5A">12vdc 1.5A</option>
            <option value="12vdc 2A">12vdc 2A</option>
            <option value="12vdc 4.1A">12vdc 4.1A</option>
            <option value="12vdc 5A">12vdc 5A</option>
        </optgroup>

        <optgroup label="Fuente centralizada">
            <option value="Fuente de poder centralizada">Fuente de poder centralizada</option>
        </optgroup>

        <optgroup label="Cajas">
            <option value="Caja estanca">Caja estanca</option>
            <option value="Caja pl√°stica 180x125x57">Caja pl√°stica 180x125x57</option>
            <option value="Caja pl√°stica 190x290x140">Caja pl√°stica 190x290x140</option>
        </optgroup>

        <optgroup label="Otro">
            <option value="Otro">Otro (especificar)</option>
        </optgroup>
    </select>

    <input type="text" id="levInsumoExtra" placeholder="Especificar modelo..."
           style="display:none; margin-top:6px;">

    <input type="number" id="levCantidad" placeholder="Cantidad" min="0">

    <select id="levUnidadOtro" style="display:none;">
        <option value="Metros">Metros</option>
        <option value="Unidades">Unidades</option>
    </select>

    <button id="levBtnAgregarMaterial" class="btn btn-success btn-sm">
        + Agregar
    </button>
</div>

<ul id="levListaMateriales"></ul>




       <button id="btnGuardarLevantamiento" class="btn btn-success">
  Guardar Levantamiento
</button>


    </div>
</div>

<div id="aliasToast" class="glass-toast">
  ‚ö†Ô∏è Recomendado agregar un alias para identificar mejor esta ubicaci√≥n
</div>


<div id="modalVerLevantamiento" class="ios-modal">
  <div class="ios-card">
   

<button class="ios-close" onclick="closeVerLevantamiento()">‚úï</button>


    <h2>üìã Levantamiento</h2>

    <div class="ios-field">
      <label>Cliente</label>
      <div id="verCliente"></div>
    </div>

    <div class="ios-field">
      <label>Direcci√≥n</label>
      <div id="verDireccion"></div>
    </div>

    <div class="ios-field">
      <label>Personal</label>
      <div id="verPersonal"></div>
    </div>

    <div class="ios-field">
      <label>Fecha</label>
      <div id="verFecha"></div>
    </div>

    <hr>
<h3>üõ† Necesidades</h3>
<div id="verNecesidades" class="ios-necesidades"></div>


   <h3>üß± Materiales</h3>
<ul id="verMateriales" class="ios-materiales"></ul>

  </div>
</div>



<script>

    let levantamientoEditando = null;
    let levantamientosCache = [];


/* ===== MODAL NUEVO LEVANTAMIENTO (FORZADO) ===== */

function openNuevoLevantamiento() {
    const modal = document.getElementById("modalNuevoLevantamiento");
    modal.classList.add("active");

    cargarClientesLev();   // clientes
    setPersonalActual();   // personal
    setFechaHoraActual();  // üëà fecha y hora autom√°tica
}



function closeNuevoLevantamiento() {
    const modal = document.getElementById("modalNuevoLevantamiento");
    if (modal) modal.classList.remove("active");
}



/* BOT√ìN */
document.getElementById("btnNuevoLevantamiento")
    ?.addEventListener("click", openNuevoLevantamiento);




    async function cargarClientesLev() {
  const select = document.getElementById("lev-clienteSelect");
  if (!select) return;

  select.innerHTML = `<option value="">Seleccione cliente</option>`;

  try {
    const token = localStorage.getItem("accessToken");
    if (!token) {
      console.error("No hay accessToken");
      return;
    }

    const res = await fetch(`${API_BASE_URL}/clientes`, {
      headers: {
        Authorization: `Bearer ${token}`
      }
    });

    if (!res.ok) {
      console.error("Error al cargar clientes", res.status);
      return;
    }

    const clientes = await res.json();

    clientes.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c.id;
      opt.textContent = c.nombre;
      select.appendChild(opt);
    });

  } catch (e) {
    console.error("Error cargando clientes:", e);
  }
}







function setPersonalActual() {
    const input = document.getElementById("lev-personal");
    if (!input) return;

    input.value =
        localStorage.getItem("userName") ||
        localStorage.getItem("usuario") ||
        localStorage.getItem("nombreUsuario") ||
        "Usuario";
}


// GUARDAR LEVANTAMIENTO 

 document.getElementById("btnGuardarLevantamiento")
        ?.addEventListener("click", guardarLevantamiento)
        console.log("boton funcionando correctamente");

async function guardarLevantamiento() {
  // 1. Capturamos los elementos primero
  const clienteSelect = document.getElementById("lev-clienteSelect");
  const cliente_id = clienteSelect.value;
  const cliente_nombre = clienteSelect.options[clienteSelect.selectedIndex]?.text || "";
  const direccion = document.getElementById("lev-direccion").value; // üí° Aqu√≠ se define 'direccion'

  // 2. Validaci√≥n b√°sica
  if (!cliente_id || !direccion) {
    alert("Amiko, selecciona cliente y direcci√≥n.");
    return;
  }

  // 3. Armamos el paquete exactamente como lo pide LevantamientosController.js
  const data = {
    cliente_id: cliente_id,
    cliente_nombre: cliente_nombre,
    direccion: direccion,
    personal: document.getElementById("lev-personal").value,
    fecha: document.getElementById("lev-fechaHora").value,
    necesidades: obtenerNecesidadesLev(), // Aseg√∫rate que esta funci√≥n devuelva el array
    materiales: levMaterialesList 
  };

  console.log("Datos a enviar:", data);

  try {
    const res = await fetch(`${API_BASE_URL}/levantamientos`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${localStorage.getItem("userToken")}` // üí° Unificado a userToken
      },
      body: JSON.stringify(data)
    });

    if (res.ok) {
      alert("‚úÖ ¬°Levantamiento guardado con √©xito!");
      location.reload(); 
    } else {
      const errorData = await res.json();
      console.error("Error del servidor:", errorData);
      alert("Error al guardar: " + (errorData.message || "Error 400/500"));
    }
  } catch (err) {
    console.error("Error de conexi√≥n:", err);
    alert("No hay conexi√≥n con el servidor de Render.");
  }
}






//LIMPIAR FORMULARIO 
function limpiarFormularioLev() {
    // Limpiar el array global de materiales
    levMaterialesList = []; 
    // Limpiar el HTML de materiales
    document.getElementById("levListaMateriales").innerHTML = "";
    // Limpiar el HTML de necesidades/fotos
    document.getElementById("lev-necesidadesContainer").innerHTML = "";
    // Resetear el select de cliente
    document.getElementById("lev-clienteSelect").value = "";
    document.getElementById("lev-direccion").value = "";
}







// ================= DIRECCI√ìN AUTOM√ÅTICA =================
async function clienteChangeLev() {
    const select = document.getElementById("lev-clienteSelect");
    const inputDir = document.getElementById("lev-direccion");

    if (!select || !inputDir || !select.value) {
        inputDir.value = "";
        return;
    }

    const token = localStorage.getItem("accessToken");

    try {
        const res = await fetch(`${API_BASE_URL}/clientes/${select.value}`, {
            headers: { Authorization: `Bearer ${token}` }
        });

        if (!res.ok) {
            console.error("Error al obtener cliente");
            inputDir.value = "";
            return;
        }

        const cliente = await res.json();

        // üëâ toma la primera direcci√≥n en texto
        inputDir.value =
            cliente?.direcciones?.[0]?.direccion ||
            cliente?.direccion ||
            "";
    } catch (e) {
        console.error("Error direcci√≥n:", e);
        inputDir.value = "";
    }
}

// conectar cambio
document.getElementById("lev-clienteSelect")
    ?.addEventListener("change", clienteChangeLev);


//SUBIR FOTOS XD 
    async function subirFotoAlServidor(file) {
    const formData = new FormData();
    formData.append("photo", file); 

    const token = localStorage.getItem("accessToken");

    try {
        // IMPORTANTE: Aseg√∫rate que esta ruta /upload exista en tu index.js o app.js del backend
        const res = await fetch(`${API_BASE_URL}/upload`, { 
            method: "POST",
            headers: { "Authorization": `Bearer ${token}` },
            body: formData
        });

        if (!res.ok) throw new Error("Error en el servidor");

        const data = await res.json();
        return data.filePath; 
    } catch (err) {
        console.error("Error detallado:", err);
        return null;
    }
}


    // ================= NECESIDADES =================

function addNecesidad() {
    const cont = document.getElementById("lev-necesidadesContainer");

    const div = document.createElement("div");
    div.className = "nec-item";

    // 1Ô∏è‚É£ Estructura HTML
    div.innerHTML = `
        <div class="nec-row">
            <div class="nec-left">
                <textarea placeholder="Describe la necesidad..." class="form-control"></textarea>
                <img class="img-preview">
            </div>

            <div class="nec-right">
                <button type="button" class="btn btn-primary btn-sm btn-foto">
                    üì∏ Tomar / Elegir foto
                </button>

                <button type="button" class="btn btn-danger btn-sm">
                    Eliminar
                </button>
            </div>
        </div>
        <hr>
    `;

    // 2Ô∏è‚É£ EL C√ìDIGO QUE PREGUNTAS VA EXACTO AQU√ç üëá
    const btnEliminar = div.querySelector(".btn-danger");
    btnEliminar.onclick = () => div.remove();

    const btnFoto = div.querySelector(".btn-foto");

    const fileInput = document.createElement("input");
    fileInput.type = "file";
    fileInput.accept = "image/*";
    fileInput.hidden = true;
    div.appendChild(fileInput);

    const imgPreview = div.querySelector(".img-preview");

    btnFoto.addEventListener("click", () => fileInput.click());

    
  fileInput.addEventListener("change", async () => {
    const file = fileInput.files[0];
    if (!file) return;

    btnFoto.innerText = "‚è≥ Subiendo...";
    btnFoto.disabled = true;

    const pathRelativo = await subirFotoAlServidor(file);

    if (pathRelativo) {
        // üí° AQU√ç EST√Å EL TRUCO: 
        // Si pathRelativo es 'uploads/foto.jpg', le pegamos la URL del Render antes.
        // Usamos API_BASE_URL y le quitamos el '/api' para que quede la ra√≠z del servidor.
        const urlServidor = API_BASE_URL.replace('/api', ''); 
        imgPreview.src = `${urlServidor}/${pathRelativo}`; 
        
        imgPreview.style.display = "block";
        btnFoto.innerText = "‚úÖ Foto Lista";
    } else {
        alert("Error al subir la imagen");
        btnFoto.innerText = "üì∏ Reintentar";
    }
    btnFoto.disabled = false;
});



    // 3Ô∏è‚É£ Agregar al contenedor (AL FINAL)
    cont.appendChild(div);
}


// bot√≥n
document.getElementById("btnAddNecesidad")
    ?.addEventListener("click", addNecesidad);




    //materiales 
function addMaterial() {
    const input = document.getElementById("lev-materialInput");
    const list = document.getElementById("lev-materialesLista");

    if (!input.value.trim()) return;

    const li = document.createElement("li");
    li.innerHTML = `
        ${input.value}
        <button type="button" onclick="this.parentElement.remove()">‚ùå</button>
    `;
    list.appendChild(li);
    input.value = "";
}

//HORA AUTMATICA
function setFechaHoraActual() {
    const input = document.getElementById("lev-fechaHora");
    if (!input) return;

    const now = new Date();

    // Formato YYYY-MM-DDTHH:MM
    const fechaHora =
        now.getFullYear() + "-" +
        String(now.getMonth() + 1).padStart(2, "0") + "-" +
        String(now.getDate()).padStart(2, "0") + "T" +
        String(now.getHours()).padStart(2, "0") + ":" +
        String(now.getMinutes()).padStart(2, "0");

    input.value = fechaHora;
}



//materiales 

/* ================= MATERIALES LEVANTAMIENTOS ================= */

let levMaterialesList = [];

const levCategoriaPorInsumo = {
    "Transceptor": "Transceptor",
    "Conector de corriente": "Conectores",

    "12vdc 1A": "Fuentes de poder",
    "12vdc 1.5A": "Fuentes de poder",
    "12vdc 2A": "Fuentes de poder",
    "12vdc 4.1A": "Fuentes de poder",
    "12vdc 5A": "Fuentes de poder",
    "Fuente de poder centralizada": "Fuentes de poder",

    "Cable": "Cableado",

    "Caja estanca": "Cajas",
    "Caja pl√°stica 180x125x57": "Cajas",
    "Caja pl√°stica 190x290x140": "Cajas",

    "Otro": "Otros"
};

const levUnidadesPorInsumo = {
    "Transceptor": "Unidades",
    "Conector de corriente": "Unidades",

    "12vdc 1A": "Unidades",
    "12vdc 1.5A": "Unidades",
    "12vdc 2A": "Unidades",
    "12vdc 4.1A": "Unidades",
    "12vdc 5A": "Unidades",

    "Fuente de poder centralizada": "Unidades",

    "Caja estanca": "Unidades",
    "Caja pl√°stica 180x125x57": "Unidades",
    "Caja pl√°stica 190x290x140": "Unidades",

    "Cable": "Metros",
    "Otro": "Unidades"
};

// ‚ûï AGREGAR MATERIAL
document.getElementById("levBtnAgregarMaterial")
    ?.addEventListener("click", () => {

        const insumoBase = document.getElementById("levInsumo").value;
        const extra = document.getElementById("levInsumoExtra").value.trim();
        const cantidad = document.getElementById("levCantidad").value.trim();

        if (!insumoBase || !cantidad) {
            alert("Completa los campos de material");
            return;
        }

        if ((insumoBase === "Fuente de poder centralizada" || insumoBase === "Otro") && !extra) {
            alert("Especifica el modelo");
            return;
        }

        let unidad;
        if (insumoBase === "Otro") {
            unidad = document.getElementById("levUnidadOtro").value;
            if (!unidad) {
                alert("Selecciona unidad");
                return;
            }
        } else {
            unidad = levUnidadesPorInsumo[insumoBase] || "Unidades";
        }

        const insumoFinal = extra ? `${insumoBase} (${extra})` : insumoBase;
        const categoria = levCategoriaPorInsumo[insumoBase] || "Otros";

        // üîÅ detectar duplicado
        const existente = levMaterialesList.find(
            m => m.insumo === insumoFinal && m.unidad === unidad
        );

        if (existente) {
            existente.cantidad += parseFloat(cantidad);
            levRenderMateriales();
            levLimpiarInputs();
            return;
        }

        levMaterialesList.push({
            insumo: insumoFinal,
            categoria,
            cantidad: parseFloat(cantidad),
            unidad
        });

        levRenderMateriales();
        levLimpiarInputs();
    });

// üßπ LIMPIAR INPUTS
function levLimpiarInputs() {
    document.getElementById("levInsumo").selectedIndex = 0;
    document.getElementById("levCantidad").value = "";
    document.getElementById("levInsumoExtra").value = "";
    document.getElementById("levInsumoExtra").style.display = "none";
    document.getElementById("levUnidadOtro").value = "";
    document.getElementById("levUnidadOtro").style.display = "none";
}

// üñ®Ô∏è RENDER MATERIALES
function levRenderMateriales() {
    const ul = document.getElementById("levListaMateriales");
    ul.innerHTML = "";

    const grupos = {};

    levMaterialesList.forEach(mat => {
        if (!grupos[mat.categoria]) grupos[mat.categoria] = [];
        grupos[mat.categoria].push(mat);
    });

    Object.keys(grupos).sort().forEach(cat => {

        const header = document.createElement("li");
        header.innerHTML = `<strong>${cat}</strong>`;
        header.style.marginTop = "10px";
        ul.appendChild(header);

        grupos[cat].forEach(mat => {
            const li = document.createElement("li");
            li.innerHTML = `
                ${mat.insumo} ‚Äì ${mat.cantidad} ${mat.unidad}
                <button class="levBtnEliminarMat">‚ùå</button>
            `;

            li.querySelector(".levBtnEliminarMat").onclick = () => {
                levMaterialesList = levMaterialesList.filter(
                    m => !(m.insumo === mat.insumo && m.unidad === mat.unidad)
                );
                levRenderMateriales();
            };

            ul.appendChild(li);
        });
    });
}

// üëÅÔ∏è MOSTRAR CAMPOS EXTRA
function levMostrarCampoExtra() {
    const insumo = document.getElementById("levInsumo").value;
    const extra = document.getElementById("levInsumoExtra");
    const unidadOtro = document.getElementById("levUnidadOtro");

    if (insumo === "Fuente de poder centralizada" || insumo === "Otro") {
        extra.style.display = "block";
    } else {
        extra.style.display = "none";
        extra.value = "";
    }

    if (insumo === "Otro") {
        unidadOtro.style.display = "block";
    } else {
        unidadOtro.style.display = "none";
        unidadOtro.value = "";
    }
}


//cargar tabla 

async function cargarTablaLevantamientos() {
  const res = await fetch(`${API_BASE_URL}/levantamientos`, {
    headers: {
      Authorization: `Bearer ${localStorage.getItem("userToken")}`
    }
  });

  const data = await res.json();
  levantamientosCache = data;

  const tbody = document.getElementById("tablaLevantamientos");
  tbody.innerHTML = "";

  data.forEach(l => {
    // üí° PostgreSQL a veces usa 'id', aseg√∫rate que el campo existe
    const idReal = l.id || l.id_levantamiento; 

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${l.cliente_nombre || 'Sin nombre'}</td>
      <td>${l.direccion}</td>
      <td>${l.personal}</td>
      <td>${new Date(l.fecha).toLocaleString()}</td>
      
      <td class="acciones">
        <button onclick="editarLevantamiento('${idReal}')">Editar</button>
        <button onclick="eliminarLevantamiento('${idReal}')">Eliminar</button>
        <button onclick="verLevantamiento('${idReal}')">Ver</button>
        <button onclick="pdfLevantamiento('${idReal}')">PDF</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

cargarTablaLevantamientos();

//obtener necesidades 

function obtenerNecesidadesLev() {
  const items = document.querySelectorAll("#lev-necesidadesContainer .nec-item");
  const necesidades = [];

  items.forEach(div => {
    const descripcion = div.querySelector("textarea")?.value || "";
    const img = div.querySelector(".img-preview");
    
    let imagenPath = null;
    if (img && img.src && img.style.display !== "none") {
      // üí° ESTA ES LA CLAVE: 
      // Si el src es "https://tu-render.com/uploads/foto.jpg"
      // lo convertimos a "uploads/foto.jpg" antes de guardar
      const urlBase = API_BASE_URL.replace('/api', '');
      imagenPath = img.src.replace(urlBase + "/", ""); 
    }

    if (descripcion.trim() !== "" || imagenPath) {
      necesidades.push({
        descripcion: descripcion,
        imagen: imagenPath 
      });
    }
  });
  return necesidades;
}


//editar el levantamiento

async function editarLevantamiento(id) {
  try {
    const res = await fetch(`${API_BASE_URL}/levantamientos/${id}`, {
      headers: { "Authorization": `Bearer ${localStorage.getItem("accessToken")}` }
    });
    const lev = await res.json();

    // 1. Guardamos el ID que estamos editando
    levantamientoEditando = id; 

    // 2. Llenamos el formulario principal
    document.getElementById("lev-clienteSelect").value = lev.clienteId;
    document.getElementById("lev-direccion").value = lev.direccion;
    document.getElementById("lev-personal").value = lev.personal;
    document.getElementById("lev-fechaHora").value = lev.fecha;

    // 3. Cargamos las necesidades (con sus fotos)
    const cont = document.getElementById("lev-necesidadesContainer");
    cont.innerHTML = ""; // Limpiamos primero
    
    if (lev.necesidades) {
      lev.necesidades.forEach(n => {
        // Reutilizamos tu l√≥gica de agregar fila, pero pasando los datos
        addNecesidadConDatos(n.descripcion, n.imagen);
      });
    }

    // 4. Cargamos los materiales
    levMaterialesList = lev.materiales || [];
    renderMaterialesLev();

    // 5. Abrimos el modal de "Nuevo Levantamiento" pero dir√° "Editar"
    openNuevoLevantamiento();
    document.querySelector("#modalNuevoLevantamiento h2").innerText = "Editar Levantamiento";
    
  } catch (err) {
    console.error("Error al cargar para editar:", err);
  }
}




//ver texto y fotos viejas del levantamieno al editar 

function addNecesidadConDatos(descripcion, urlFoto) {
    addNecesidad(); // Llama a tu funci√≥n normal para crear la fila
    const filas = document.querySelectorAll("#lev-necesidadesContainer .nec-item");
    const ultimaFila = filas[filas.length - 1];
    
    // Rellenamos con lo que ya exist√≠a
    ultimaFila.querySelector("textarea").value = descripcion;
    if (urlFoto) {
        const img = ultimaFila.querySelector(".img-preview");
        img.src = urlFoto;
        img.style.display = "block";
        ultimaFila.querySelector(".btn-foto").innerText = "‚úÖ Foto Cargada";
    }
}

//ELIMINAR LEANTAMIENTO 
function eliminarLevantamiento(id) {
  if (!confirm("¬øEliminar levantamiento?")) return;

  fetch(`${API_BASE_URL}/levantamientos/${id}`, {
    method: "DELETE",
    headers: {
      Authorization: `Bearer ${localStorage.getItem("userToken")}`
    }
  }).then(() => cargarTablaLevantamientos());
}





//ver levantamiento

async function verLevantamiento(id) {
  // 1. Usamos el token correcto (userToken)
  const token = localStorage.getItem("userToken"); 
  
  console.log("ID solicitado a Postgres:", id);
  
  try {
    const res = await fetch(`${API_BASE_URL}/levantamientos/${id}`, {
      headers: { "Authorization": `Bearer ${token}` } // üëà Token unificado
    });

    if (!res.ok) {
        const errorData = await res.json();
        throw new Error(errorData.message || "Error al obtener datos");
    }

    const lev = await res.json();
    console.log("Datos recibidos:", lev);

    // Llenar modal
    document.getElementById("verCliente").textContent = lev.cliente_nombre || lev.clienteNombre || "Sin nombre";
    document.getElementById("verDireccion").textContent = lev.direccion || "Sin direcci√≥n";
    document.getElementById("verPersonal").textContent = lev.personal || "N/A";
    document.getElementById("verFecha").textContent = new Date(lev.fecha).toLocaleString() || "N/A";

    renderNecesidadesVer(lev.necesidades || []);
    renderMaterialesVer(lev.materiales || []);

    const modal = document.getElementById("modalVerLevantamiento");
    if (modal) modal.classList.add("active");

  } catch (err) {
    console.error("Error:", err);
    alert("Error al ver levantamiento: " + err.message);
  }
}


function pdfLevantamiento(id) {
  window.open(`${API_BASE_URL}/levantamientos/${id}/pdf`, "_blank");
}





//NECESIDADES REGISTRADAS 
function renderNecesidadesVer(necesidades = []) {
  const cont = document.getElementById("verNecesidades");
  cont.innerHTML = "";

  if (necesidades.length === 0) {
    cont.innerHTML = "<p>No hay fotos o necesidades registradas.</p>";
    return;
  }

  necesidades.forEach(n => {
    const div = document.createElement("div");
    div.className = "ver-necesidad";

    // Si la imagen es un link de Cloudinary, se usa directo
    // Si es ruta relativa, le pegamos la URL del Render
    let srcImagen = n.imagen;
    if (srcImagen && !srcImagen.startsWith('http')) {
        const urlServidor = API_BASE_URL.replace('/api', '');
        srcImagen = `${urlServidor}/${srcImagen}`;
    }

    div.innerHTML = `
      <p><strong>Descripci√≥n:</strong> ${n.descripcion || "Sin descripci√≥n"}</p>
      ${srcImagen ? `<img src="${srcImagen}" style="width:100%; max-width:400px; border-radius:8px; margin-bottom:15px;">` : ""}
    `;
    cont.appendChild(div);
  });
}



//MATERIALES 
function renderMaterialesVer(materiales = []) {
  const ul = document.getElementById("verMateriales");
  ul.innerHTML = "";

  if (!materiales.length) {
    ul.innerHTML = "<li class='muted'>Sin materiales</li>";
    return;
  }

  materiales.forEach(m => {
    const li = document.createElement("li");
    li.textContent = `${m.insumo} ‚Äì ${m.cantidad} ${m.unidad}`;
    ul.appendChild(li);
  });
}


//CERRAR EL LEVANTAMIENTO 

function cerrarVerLevantamiento() {
    document.getElementById("modalVerLevantamiento")
        .classList.remove("active");
}


//limpiar formulario 
function limpiarFormularioLev() {
  // limpiar materiales
  levMaterialesList = [];
  document.getElementById("levListaMateriales").innerHTML = "";

  // limpiar necesidades
  document.getElementById("lev-necesidadesContainer").innerHTML = "";
}


console.log("JS LEVANTAMIENTOS CARGADO");


function addNecesidadConDatos(descripcion, urlFoto) {
    addNecesidad(); // Crea la fila vac√≠a
    const filas = document.querySelectorAll("#lev-necesidadesContainer .nec-item");
    const ultimaFila = filas[filas.length - 1];
    
    if (ultimaFila) {
        ultimaFila.querySelector("textarea").value = descripcion || "";
        if (urlFoto) {
            const img = ultimaFila.querySelector(".img-preview");
            img.src = urlFoto;
            img.style.display = "block";
            ultimaFila.querySelector(".btn-foto").innerText = "‚úÖ Foto Cargada";
        }
    }
}

    
</script>







</body>
</html>