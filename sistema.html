<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AETech App</title>

    <link rel="stylesheet" href="login.css">
    <link rel="icon" href="img/logoAEtech.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Los estilos CSS se encuentran en el archivo login.css */
        
    </style>
</head>
<body>

    <!-- üîπ Pantalla de carga -->
<div id="loader" class="loader-overlay" style="display: none;">
  <div class="loader-container">
    <div class="spinner"></div>
    <p>Procesando, por favor espera...</p>
  </div>
</div>



    <div class="container">
        
        <header>
            <button onclick="window.location.href='../sistema.html'" id="btnLogo" class="btnLogo">
                <img src="img/logoAEtech.png" width="80px" height="80px">
            </button>
                         <section class="login-section">
    <div class="login-menu">
    
    <!-- üîî BOT√ìN DE NOTIFICACIONES -->
    <div class="notificaciones-container">
        <button id="btnNotificaciones" class="notif-btn" aria-label="Notificaciones">
            üîî <span id="numNotificaciones">0</span>
        </button>
        <ul id="listaNotificaciones" class="notificaciones-lista"></ul>
    </div>

    <!-- üë§ BOT√ìN DE PERFIL -->
    <button id="login-button" aria-label="Perfil de usuario">
        <i class="fas fa-user-circle"></i>
    </button>

    <div class="dropdown-menu" id="dropdown-menu">
        <!-- Informaci√≥n del perfil -->
        <div class="profile-info" id="profile-info">
            <img src="img/perfil.jpg" alt="perfil.jpg" class="profile-image">
            <p class="profile-name">Nombre del Usuario</p>
            <p class="profile-email">usuario@email.com</p>
        </div>
        <!-- Bot√≥n de cerrar sesi√≥n -->
        <button id="logout-button" onclick="logout('logout-button')">Cerrar Sesi√≥n</button>
    </div>
</div>


    <script>
        const loginButton = document.getElementById('login-button');
        const dropdownMenu = document.getElementById('dropdown-menu');
        const profileInfo = document.getElementById('profile-info');
        const logoutButton = document.getElementById('logout-button');

        // Oculta el men√∫ desplegable al principio
        dropdownMenu.style.display = 'none';

        loginButton.addEventListener('click', (event) => {
            event.stopPropagation(); // Evita que el clic se propague
            // Muestra u oculta el men√∫ al hacer clic en el icono
            if (dropdownMenu.style.display === 'none') {
                dropdownMenu.style.display = 'block';
            } else {
                dropdownMenu.style.display = 'none';
            }
        });

        // Cierra el men√∫ si se hace clic fuera de √©l
        document.addEventListener('click', (event) => {
            if (!loginButton.contains(event.target) && !dropdownMenu.contains(event.target)) {
                dropdownMenu.style.display = 'none';
            }
        });

        

        // Funci√≥n para actualizar la informaci√≥n del perfil (ejemplo)
        function updateProfileInfo(name, email, image) {
            document.querySelector('.profile-name').textContent = name;
            document.querySelector('.profile-email').textContent = email;
            document.querySelector('.profile-image').src = image;
        }

        
    </script>
</section>


            
        </header>

    <nav class="sidebar-nav">
        <button class="menu-toggle" onclick="toggleMenu()">
            &#9776; 
        </button>

        <ul id="main-menu">
            <li><button onclick="mostrarContenido('Tablero')">Tablero</button></li>
            <li><button onclick="mostrarContenido('organizador-tareas')">Tareas</button></li>
          <li><button onclick="mostrarContenido('listaLevantamientos')">Levantamientos</button></li>


           
            <li><button onclick="mostrarContenido('Sucursales')">Sucursales</button></li>
           
            <li><button onclick="mostrarContenido('Administracion')">Personal</button></li>
            <li><button onclick="mostrarContenido('Clientes')">Clientes</button></li>
    ¬†¬†¬†¬†</ul>
    </nav>
        <main>



            
    <section id="Evidencia" class="main-content ">
                
    </section>



        <section id="Tablero" class="main-content">

  <div class="tablero-container">
   <div class="top-bar">
    <div class="social-icons">
     <a href="https://wa.me/2221920179" target="_blank" dm_dont_rewrite_url="true" aria-label="whatsapp" onclick="dm_gaq_push_event &amp; dm_gaq_push_event('socialLink', 'click', 'Whatsapp')"> <span class="dmSocialWhatsapp dm-social-icons-whatsapp oneIcon socialHubIcon style6" aria-hidden="true" data-hover-effect="float" class="social-icon"><img src="img/whatsapp.jpg" alt="whatsapp.jpg"></a></span>
     <a href="https://facebook.com/AETech18" target="_blank" dm_dont_rewrite_url="true" aria-label="facebook" onclick="dm_gaq_push_event &amp;  dm_gaq_push_event('socialLink', 'click', 'Facebook')"> <span class="dmSocialFacebook dm-social-icons-facebook oneIcon socialHubIcon style6" aria-hidden="true" data-hover-effect="float" class="social-icon"><img src="img/facebook.jpg" alt="facebook.jpg"></a></span>
     <a href="http://instagram.com/aetech18" target="_blank" dm_dont_rewrite_url="true" aria-label="instagram" onclick="dm_gaq_push_event &amp; dm_gaq_push_event('socialLink', 'click', 'Instagram')"> <span class="dmSocialInstagram dm-social-icons-instagram oneIcon socialHubIcon style6" aria-hidden="true" data-hover-effect="float" class="social-icon"><img src="img/instagram.jpg" alt="instagram.jpg"></a></span>
     <a href="mailto:contacto@aetech.com.mx" dm_dont_rewrite_url="true" aria-label="email" onclick="dm_gaq_push_event &amp; dm_gaq_push_event('socialLink', 'click', 'Email')" target="_blank"> <span class="dmSocialEmail dm-social-icons-email oneIcon socialHubIcon style6" aria-hidden="true" data-hover-effect="float" class="social-icon"><img src="img/gmail.jpg" alt="gmail.jpg"></a></span>
     <button class="glass-btn-ios" onclick="abrirTarjetaDigital()">
        üìá
    </button>
    </div>
    
    
     <img src="img/imgae.jpg" alt="imgae.jpg">
     


    <div class="contact-info">
     <i class="fas fa-phone"></i> <a class="u_1788509405 default dmDefaultGradient align-center dmCall voipReplacement dmWidget dmNoMark dmWwr" contenteditable="false" onclick=";return dm_gaq_push_event('ClickToCall', 'Call',null,'4f1868a89c9c49a1800af08875200556', this);" id="1788509405" dmle_extension="clicktocall" data-element-type="clicktocall" data-buttonstyle="FLAT_ROUND_ICON" wr="true" data-display-type="block" localization_key_description="googleTranslate.HLc6QEJ.39" icon="true" surround="true" description="Llama ahora" adwords="" icon-name="icon-phone" phone="222 143 4363" text="" image="" target="_blank"> <span class="iconBg" aria-hidden="true"></a> 
     <a class="default dmDefaultGradient align-center dmCall voipReplacement dmWidget dmNoMark dmWwr" href="tel:222 143 4363" contenteditable="false" onclick=";return dm_gaq_push_event('ClickToCall', 'Call',null,'4f1868a89c9c49a1800af08875200556', this);" id="1302615267" dmle_extension="clicktocall" data-element-type="clicktocall" wr="true" data-display-type="block" localization_key_description="googleTranslate.oJ4SyII.32" icon="true" surround="true" description="Llamar" adwords="" icon-name="icon-phone" phone="222 144 4363" text="" image="" target="_blank"> <span class="iconBg" aria-hidden="true"> <span class="icon hasFontIcon icon-phone"></span> 
        </span> 
        <span class="text">Llama ahora</span> 
        <span class="text phoneNumHolder">222 144 4363</span>
     </a>
    </div>
   </div>

   <div id="modalTarjeta" class="modal-overlay-tarjeta" style="display:none;">
    <div class="modal-content-tarjeta">
        <span class="close-tarjeta" onclick="cerrarTarjetaDigital()">√ó</span>
        
        <h2 style="color: #005e73; margin-top: 0;">AE Tech - Contacto</h2>
        
        <img src="img/tarjeta.jpeg" alt="Tarjeta AE Tech" class="img-tarjeta">

        <p style="color: #333; font-size: 14px; margin: 10px 0;">Escanea para contacto directo:</p>
        
        <div class="qr-container">
            <img src="https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=https://wa.me/2221920179" alt="QR WhatsApp">
        </div>

        <p style="margin-top: 15px; font-weight: bold; color: #007bff; letter-spacing: 1px;">SOPORTE T√âCNICO</p>
    </div>
</div>
   
  <section id="TableroAetech" class="tablero-aetech">
    <div class="quick-actions">
    <div class="qa-card" onclick="mostrarContenido('organizador-tareas')">
        üìù <span>Tareas</span>
    </div>

    <div class="qa-card" onclick="mostrarContenido('Clientes')">
        üë• <span>Clientes</span>
    </div>

    <div class="qa-card" onclick="mostrarContenido('listaLevantamientos')">
    üìã <span>Levantamientos</span>
</div>

    <div class="qa-card" onclick="mostrarContenido('Administracion')">
        üë§ <span>Personal</span>
    </div>

    <div class="qa-card" id="card-cuentas" onclick="accesoCuentas()" style="display: none;">
        üí≤ <span>Cuentas</span>
    </div>
</div>
  <div class="dashboard-card">
    <h2>üëã ¬°Hola, <span id="nombreUsuario"></span>!</h2>
    <p id="fraseDia">"La tecnolog√≠a es mejor cuando une a las personas."</p>
    <div class="info-extra">
      <p>üïí <span id="horaActual"></span></p>
      <p>üìÖ <span id="fechaActual"></span></p>
      <p>üå§Ô∏è <span id="climaActual">Cargando clima...</span></p>
    </div>
  </div>
</section>

   

   <div class="bottom-bar">
    <p>¬© 2025 AE Tech. Todos los derechos reservados.</p>
   </div>
  </div>
     
            </section>


         <!-- NUEVO CONTENEDOR ORGANIZADOR DE TAREAS -->
<!-- Secci√≥n de Tareas -->
<section id="organizador-tareas" class="main-content">
    <div class="p-8">
        <h2 class="text-3xl font-bold mb-6 text-gray-800 border-b pb-2">Organizador de Tareas</h2>

        <div class="flex justify-between items-center mb-6">
            <p class="text-gray-600">Gesti√≥n centralizada de las tareas asignadas y sus estados.</p>
            <button id="openAddTaskModal" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 transform hover:scale-105">
                + Nueva Tarea
            </button>
            <button id="openAddExpressTaskModal" onclick="abrirExpressModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 transform hover:scale-105">
                + Tarea Express
            </button>
        </div>

        <!-- Aqu√≠ se mover√° el contenedor de la tabla -->

    </div>

    <div id="filtrosTareas"
     style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:20px; width:100%;">
    
    <select id="filterCliente" class="form-control">
        <option value="">Todos los clientes</option>
    </select>

    <select id="filterActividad" class="form-control">
        <option value="">Todas las actividades</option>
    </select>


    <button id="btnLimpiarFiltros"
        style="padding:6px 14px; border-radius:6px; background:#850f0f;
               border:1px solid #850f0f; cursor:pointer; height:32px;">
        Limpiar
    </button>
</div>




    <!-- Contenedor de la tabla (MOVIDO AQU√ç) -->
    <div class="bg-white shadow-xl rounded-xl overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200" id="tareasTable">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">T√≠tulo</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asignado a</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Direccion</th>
                     <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha L√≠mite</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200" id="tareasBody">
                <!-- Aqu√≠ se cargar√°n las tareas con JavaScript -->
                <tr>
                    <td colspan="6" class="p-4 text-center text-gray-500">Cargando tareas...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- MODAL para Agregar/Editar Tarea -->
    <div id="tareaModal"
        class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6">
            <h3 id="tareaModalTitle" class="text-2xl font-semibold mb-4 border-b pb-2">Crear Nueva Tarea</h3>
            <form id="tareaForm">
                <input type="hidden" id="tareaId">

                <div class="mb-4">
                    <label for="tareaTitulo" class="block text-sm font-medium text-gray-700">T√≠tulo</label>
                    <input type="text" id="tareaTitulo" name="titulo" required
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                        
                </div>

                <div class="mb-4">
                    <label for="tareaDescripcion" class="block text-sm font-medium text-gray-700">Descripci√≥n</label>
                    <textarea id="tareaDescripcion" name="descripcion" required rows="3"
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="tareaAsignadoA" class="block text-sm font-medium text-gray-700">Asignar a
                            Usuario</label>

                        <select id="tareaAsignadoA" name="asignadoA" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="" disabled selected>-- Seleccione Usuario --</option>
                            <!-- Opciones cargadas din√°micamente -->
                        </select>
                    </div>
                    <div>
                        <label for="tareaClienteId" class="block text-sm font-medium text-gray-700">Cliente
                            Asociado</label>
                        <select id="tareaClienteId" name="clienteId" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="" disabled selected>-- Seleccione Cliente --</option>
                        </select>
                    </div>
                    <div>
                        <label for="tareaFechaLimite" class="block text-sm font-medium text-gray-700">Fecha
                            L√≠mite</label>
                        <input type="date" id="tareaFechaLimite" name="fechaLimite" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>

                <div class="mb-4">
    <label for="tareaDireccionCliente" class="block text-sm font-medium text-gray-700">
        Direcci√≥n del Cliente
    </label>

    <select id="tareaDireccionCliente" name="direccionCliente"
        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
        <option value="">-- Seleccione Direcci√≥n --</option>
    </select>
</div>


                <div class="mb-4">
                    <label for="tareaActividadId" class="block text-sm font-medium text-gray-700">Tipo de
                        Actividad</label>
                    <select id="tareaActividadId" name="actividad" required
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="" disabled selected>-- Seleccione Actividad --</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label for="tareaEstado" class="block text-sm font-medium text-gray-700">Estado</label>
                    <select id="tareaEstado" name="estado" required
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="Pendiente">Pendiente</option>
                        <option value="En Progreso">En Progreso</option>
                        <option value="Completada">Completada</option>
                        <option value="Bloqueada">Bloqueada</option>
                    </select>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="closeTareaModal"
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-300">
                        Cancelar
                    </button>
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">
                        Guardar Tarea
                    </button>
                </div>
            </form>
        </div>
    </div>


    <div id="tareaExpressModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 500px;"> <div class="modal-header">
            <h2 style="margin: 0; color: #333;">üöÄ Tarea Express</h2>
            <button type="button" onclick="cerrarExpressModal()" class="close-btn" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
        </div>

        <form id="tareaExpressForm" style="padding: 20px;">
            <div class="form-group" style="margin-bottom: 15px;">
                <label style="display: block; font-weight: bold; margin-bottom: 5px;">T√≠tulo de la Tarea</label>
                <input type="text" id="expTitulo" required style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px;">
            </div>

            <div class="form-group" style="margin-bottom: 15px;">
                <label style="display: block; font-weight: bold; margin-bottom: 5px;">Descripci√≥n (opcional)</label>
                <textarea id="expDescripcion" rows="2" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px;"></textarea>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 15px; background: #f9f9f9; padding: 10px; border-radius: 8px;">
                <div style="flex: 1;">
                    <label style="font-size: 11px; color: #666; font-weight: bold; text-transform: uppercase;">Solicitante</label>
                    <input type="text" id="expUsuarioAuto" readonly style="width: 100%; border: none; background: transparent; font-weight: 600;">
                </div>
                <div style="flex: 1;">
                    <label style="font-size: 11px; color: #666; font-weight: bold; text-transform: uppercase;">Fecha</label>
                    <input type="text" id="expFechaAuto" readonly style="width: 100%; border: none; background: transparent; font-weight: 600;">
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <div style="flex: 1;">
                    <label style="display: block; font-weight: bold; margin-bottom: 5px;">Cliente</label>
                    <select id="expClienteId" required style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px;"></select>
                </div>
                <div style="flex: 1;">
                    <label style="display: block; font-weight: bold; margin-bottom: 5px;">Direccion</label>
                    <select id="expDireccionCliente" required style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px;"></select>
                </div>
                <div style="flex: 1;">
                    <label style="display: block; font-weight: bold; margin-bottom: 5px;">Actividad</label>
                    <select id="expActividadId" required style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px;"></select>
                </div>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button type="button" onclick="cerrarExpressModal()" class="btn-secondary" style="padding: 10px 20px; border-radius: 8px; cursor: pointer;">Cancelar</button>
                <button type="submit" class="btn-primary" style="padding: 10px 20px; border-radius: 8px; cursor: pointer; background: #4f46e5; color: white; border: none; font-weight: bold;">Enviar a Admin</button>
            </div>
        </form>
    </div>
</div>

</section>

            
     








            <section id="Sucursales" class="main-content">
    <h2>Sucursales</h2>
    <div class="contenedor-tarjetas">

        <!-- Tarjetas de Sucursales  -->
        <div class="tarjeta">
            <div class="map-container">
                <h3>Sucursal Atlixco</h3>
                <p>Calzada Oaxaca #3112, segundo piso, Francisco I. Madero, Atlixco, Puebla</p>
                <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3774.9294048160427!2d-98.43886917431595!3d18.89021274801054!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x85cfb3b2f3c72c4b%3A0x7997679f2d024d6e!2sAE%20TECH!5e0!3m2!1ses!2smx!4v1759349314481!5m2!1ses!2smx"
                    width="600" height="450" style="border:0;" allowfullscreen="" loading="lazy"
                    referrerpolicy="no-referrer-when-downgrade"></iframe>
            </div>
        </div>

        <div class="tarjeta">
            <div class="map-container">
                <h3>Punto de Venta Atlixco</h3>
                <p>Calle 15 Poniente #107, Alvaro Obregon, Atlixco, Puebla</p>
                <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d7549.322982149112!2d-98.43763703234865!3d18.902092719110687!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x85cfb47f9d4aa489%3A0xecab6b4b061b7393!2sAE%20TECH!5e0!3m2!1ses!2smx!4v1770144995213!5m2!1ses!2smx"
                    width="600" height="450" style="border:0;" allowfullscreen="" loading="lazy"
                    width="600" height="450" style="border:0;" allowfullscreen="" loading="lazy"
                    referrerpolicy="no-referrer-when-downgrade"></iframe>
            </div>
        </div>

</section>
</section>


<section id="agregar-comentario" class="main-content">
    <h2>Agregar Comentario</h2>
    <form id="form-comentario">
        <div class="form-group">
            <label for="comentario">Comentario:</label>
            <textarea id="comentario" name="comentario" rows="4" required></textarea>
        </div>
        <div class="form-group">
            <label>Calificaci√≥n:</label>
            <div class="rating">
                <span class="star" data-rating="1">&#9733;</span>
                <span class="star" data-rating="2">&#9733;</span>
                <span class="star" data-rating="3">&#9733;</span>
                <span class="star" data-rating="4">&#9733;</span>
                <span class="star" data-rating="5">&#9733;</span>
                <input type="hidden" id="rating-value" name="rating" value="0">
            </div>
        </div>
        <button type="submit">Publicar Comentario</button>
        <button type="button" id="btn-cancelar-comentario">Cancelar</button>
    </form>

    <section id="lista-comentarios" style="display: none;">
        <h2>Comentarios</h2>
        <!-- Aqu√≠ se mostrar√°n los comentarios -->
        <!-- Ejemplo de un comentario -->
        <div class="comentario">
            <div class="comentario-header">
                <img src="img/default-user.png" alt="Avatar" class="comentario-avatar">
                <div class="comentario-info">
                    <span class="comentario-autor">Nombre del Autor</span>
                    <div class="comentario-calificacion">
                        <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i
                            class="fas fa-star"></i><i class="far fa-star"></i>
                    </div>
                </div>
            </div>
            <p class="comentario-texto">Este es un ejemplo de comentario. ¬°El servicio fue excelente!</p>
        </div>
        <!-- Fin del ejemplo de comentario -->
    </section>
</section>

<script>
            // Funci√≥n para alternar la visibilidad del men√∫
        function toggleUserMenu() {
            const menu = document.getElementById('user-dropdown-menu');
            menu.classList.toggle('show');
        }

        // Funci√≥n para cargar los datos en el men√∫ al iniciar la p√°gina
        function loadUserInfo() {
            const name = localStorage.getItem('userName') || 'Usuario';
            const email = localStorage.getItem('userEmail') || 'No logeado';

            document.getElementById('menu-user-name').textContent = name;
            document.getElementById('menu-user-email').textContent = email;
        }

    document.addEventListener('DOMContentLoaded', function () {
        const agregarComentarioSection = document.getElementById('agregar-comentario');
        const formComentario = document.getElementById('form-comentario');
        const listaComentarios = document.getElementById('lista-comentarios');
        const btnCancelarComentario = document.getElementById('btn-cancelar-comentario');
        const stars = document.querySelectorAll('.star');
        const ratingValueInput = document.getElementById('rating-value');
        const profileButton = document.getElementById('user-profile-btn');
        const logoutMenuButton = document.getElementById('menu-logout-btn');

    if (profileButton && logoutMenuButton) {
        // 1. Conecta el bot√≥n de perfil para abrir/cerrar el men√∫
        profileButton.addEventListener('click', toggleUserMenu);
        
        // 2. Conecta el bot√≥n de cerrar sesi√≥n del men√∫
        logoutMenuButton.addEventListener('click', logout);
        
        // 3. Carga los datos del usuario
        loadUserInfo();
    }


        // Ocultar la secci√≥n de comentarios al cargar la p√°gina
        listaComentarios.style.display = 'none';

        // Cancelar la creaci√≥n del comentario
        btnCancelarComentario.addEventListener('click', function () {
            document.getElementById('comentario').value = '';
            ratingValueInput.value = "0";
            stars.forEach(star => star.classList.remove('selected'));
            
        });

        // Publicar el comentario
        formComentario.addEventListener('submit', function (event) {
            event.preventDefault();

            const comentario = document.getElementById('comentario').value;
            const ratingValue = ratingValueInput.value;

            if (!comentario || ratingValue === "0") {
                alert('Por favor, ingrese un comentario y seleccione una calificaci√≥n.');
                return;
            }

            // Crear el elemento del comentario
            const nuevoComentario = document.createElement('div');
            nuevoComentario.classList.add('comentario');
            nuevoComentario.innerHTML = `
                <div class="comentario-header">
                    <img src="img/default-user.png" alt="Avatar" class="comentario-avatar">
                    <div class="comentario-info">
                        <span class="comentario-autor">An√≥nimo</span>
                        <div class="comentario-calificacion">
                            ${generarEstrellas(ratingValue)}
                        </div>
                    </div>
                </div>
                <p class="comentario-texto">${comentario}</p>
            `;

            listaComentarios.appendChild(nuevoComentario);

            // Limpiar el formulario
            document.getElementById('comentario').value = '';
            ratingValueInput.value = "0"; // Reset rating value
            stars.forEach(star => star.classList.remove('selected')); // Remove selected class

            listaComentarios.style.display = 'block'; // Mostrar la lista de comentarios al publicar
        });

        // Funci√≥n para generar las estrellas seg√∫n la calificaci√≥n
        function generarEstrellas(rating) {
            let estrellas = '';
            for (let i = 0; i < rating; i++) {
                estrellas += '<i class="fas fa-star"></i>';
            }
            for (let i = rating; i < 5; i++) {
                estrellas += '<i class="far fa-star"></i>';
            }
            return estrellas;
        }

        // Star rating functionality
        stars.forEach(star => {
            star.addEventListener('click', function () {
                const rating = this.dataset.rating;
                ratingValueInput.value = rating;

                // Highlight selected stars
                stars.forEach(star => star.classList.remove('selected'));
                for (let i = 0; i < rating; i++) {
                    stars[i].classList.add('selected');
                }
            });
        });
    });
</script>


<section id="Administracion" class="main-content">
    <h2>Administraci√≥n de Usuarios</h2>

    <h3>Usuarios con Roles</h3>
    <div class="datagrid-container">
        <table id="datagridUsuariosRoles">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Email</th>
                    <th>Rol</th>
                    <th>Contrase√±a</th>
                    <th>Acciones</th> </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>

</section>


<section id="Clientes" class="main-content">
    <h3>Clientes</h3>
    <button id="btnIrFormularioCliente" class="glass-btn-ios">
    <span class="glass-text">+ Agregar Cliente</span>
    <span class="shine"></span>
</button>

    <div class="datagrid-container">
        <table id="datagridClientes">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Email</th>
                    <th>Direcci√≥n</th> 
                    <th>Tel√©fono</th>
                    <th>Acciones</th> </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>
  <div class="form-container">
    <div class="logo-container">
      <img src="img/logoAEtech.png" alt="logoAEtech">
    </div>

    <form id="registroClienteForm"> 
      <div class="form-group">
        <label for="client-nombre">Nombre:</label>
        <input type="text" id="client-nombre" name="nombre" required> 
      </div>

      <div class="form-group">
        <label for="client-email">Email (opcional):</label>
        <input type="email" id="client-email" name="email" placeholder="Ej. usuario@correo.com">
      </div>

      <div class="form-group">
        <label for="client-telefono">Tel√©fono:</label>
        <input type="text" id="client-telefono" name="telefono" placeholder="Ej. 2441234567" required> 
      </div>

      <div class="form-group">
        <label for="client-estado">Estado:</label>
        <select id="client-estado" name="estado">
          <option value="">Selecciona un estado</option>
          <option value="Aguascalientes">Aguascalientes</option>
          <option value="Baja California">Baja California</option>
          <option value="Baja California Sur">Baja California Sur</option>
          <option value="Campeche">Campeche</option>
          <option value="Chiapas">Chiapas</option>
          <option value="Chihuahua">Chihuahua</option>
          <option value="Ciudad de M√©xico">Ciudad de M√©xico</option>
          <option value="Coahuila">Coahuila</option>
          <option value="Colima">Colima</option>
          <option value="Durango">Durango</option>
          <option value="Estado de M√©xico">Estado de M√©xico</option>
          <option value="Guanajuato">Guanajuato</option>
          <option value="Guerrero">Guerrero</option>
          <option value="Hidalgo">Hidalgo</option>
          <option value="Jalisco">Jalisco</option>
          <option value="Michoac√°n">Michoac√°n</option>
          <option value="Morelos">Morelos</option>
          <option value="Nayarit">Nayarit</option>
          <option value="Nuevo Le√≥n">Nuevo Le√≥n</option>
          <option value="Oaxaca">Oaxaca</option>
          <option value="Puebla">Puebla</option>
          <option value="Quer√©taro">Quer√©taro</option>
          <option value="Quintana Roo">Quintana Roo</option>
          <option value="San Luis Potos√≠">San Luis Potos√≠</option>
          <option value="Sinaloa">Sinaloa</option>
          <option value="Sonora">Sonora</option>
          <option value="Tabasco">Tabasco</option>
          <option value="Tamaulipas">Tamaulipas</option>
          <option value="Tlaxcala">Tlaxcala</option>
          <option value="Veracruz">Veracruz</option>
          <option value="Yucat√°n">Yucat√°n</option>
          <option value="Zacatecas">Zacatecas</option>
        </select>
      </div>

      <div class="form-group">
        <label for="client-municipio">Municipio:</label>
        <input type="text" id="client-municipio" name="municipio" placeholder="Ej. Atlixco">
      </div>

      <!-- CONTENEDOR PRINCIPAL DE DIRECCIONES -->
    <div class="form-group">
        <label>Direcciones del Cliente:</label>

        <div id="direccionesContainerRegistro">
        <div class="direccion-item">
            <input
            type="text"
            name="alias[]"
            placeholder="Alias (opcional) ej. Sucursal Centro"
            class="input-alias"
            />
            
            <input
            type="text"
            name="direccion[]"
            placeholder="Ej. Calle 10 Sur #123 o link Google Maps"
            required
            />

            <button type="button" class="btn-remove-dir"
            onclick="this.parentElement.remove()">
            Eliminar
            </button>
        </div>
        </div>


        <button type="button" id="btnAgregarDireccionRegistro" class="btn-add-dir">
            + Agregar otra direcci√≥n
        </button>
    </div>


      <button type="submit">Registrar Cliente</button>
    </form>
  </div>
  
</section>








<section id="Actividades" class="main-content">
  <h2 class="titulo-seccion">üì∏ Registro de Evidencias</h2>

  <div id="contenedor-evidencias" class="evidencias-grid">

    <!-- Campo 1 -->
    <div class="card-evidencia">
      <label>T√≠tulo de la evidencia</label>
      <input type="text" name="titulo[]" placeholder="Ej: Foto antes de la instalaci√≥n">
      <!-- PREVISUALIZACI√ìN DE IMAGEN -->
<div class="preview-container">
  <img class="preview-img" src="" alt="Vista previa" style="display:none;">
</div>

      <label class="label-file">
        <i class="fa-solid fa-camera"></i> Tomar Foto / Elegir Archivo
        <input type="file" name="archivos" class="archivo" accept="image/*">
      </label>
    </div>

    <!-- Campo 2 -->
    <div class="card-evidencia">
      <label>T√≠tulo de la evidencia</label>
      <input type="text" name="titulo[]" placeholder="Ej: Foto despu√©s de la instalaci√≥n">
      <!-- PREVISUALIZACI√ìN DE IMAGEN -->
<div class="preview-container">
  <img class="preview-img" src="" alt="Vista previa" style="display:none;">
</div>

      <label class="label-file">
        <i class="fa-solid fa-camera"></i> Tomar Foto / Elegir Archivo
        <input type="file" name="archivos" class="archivo" accept="image/*">
      </label>
    </div>
  </div>

  <!-- FIRMA DEL CLIENTE -->
    <section id="firma-cliente" class="firma-section">
    <h2>üñäÔ∏è Firma del Cliente</h2>
    <canvas id="signature-pad" width="400" height="200"></canvas>
    <div class="firma-botones">
        <button type="button" id="btnLimpiarFirma">
        <i class="fa-solid fa-eraser"></i> Limpiar
        </button>
        <button type="button" id="btnGuardarFirma">
        <i class="fa-solid fa-floppy-disk"></i> Guardar Firma
        </button>
    </div>
    </section>
  <div class="botones-evidencias">
    <button type="button" id="btnAgregarFoto">
      <i class="fa-solid fa-plus"></i> Agregar Foto Adicional
    </button>


    <button type="button" id="btnGuardarEvidencias">
      <i class="fa-solid fa-floppy-disk"></i> Guardar Evidencias
    </button>
  </div>
</section>

  <div id="editModal" class="modal">
  <div class="modal-content">
    <span class="close-button" onclick="closeModal('editModal')">&times;</span>
    <h3>Editar Registro (<span id="recordType"></span>)</h3>

    <form id="editForm">
      <input type="hidden" id="edit-id" name="id">
      <input type="hidden" id="edit-type" name="type">

      <label for="edit-nombre">Nombre:</label>
      <input type="text" id="edit-nombre" name="nombre" required>

      <label for="edit-email">Email:</label>
      <input type="email" id="edit-email" name="email">

      <!-- CAMPOS SOLO PARA USUARIOS -->
      <div id="userFields" style="display:none;">
        <label for="edit-rol">Rol:</label>
        <select id="edit-rol" name="rol">
          <option value="" disabled selected>-- Selecciona un rol --</option>
          <option value="Admin">Admin</option>
          <option value="Ingeniero">Ingeniero</option>
          <option value="Residente">Residente</option>
          <option value="Practicante">Practicante</option>
        </select>
      </div>

      <!-- CAMPOS SOLO PARA CLIENTE -->
      <div id="clientFields" style="display:none;">
        <label for="edit-telefono">Tel√©fono:</label>
        <input type="text" id="edit-telefono" name="telefono">

        <label for="">Direcciones del Cliente:</label>

        <div id="direccionesContainer"></div>

        <button type="button" onclick="agregarDireccion()" class="btn-add-dir">
          + Agregar direcci√≥n
        </button>
      </div>

      <button type="submit" class="btn-save">Guardar Cambios</button>
    </form>
  </div>
</div>
   
    <script>



        // Funci√≥n para mostrar el contenido de una secci√≥n y ocultar las dem√°s
        

        function toggleEvaluacion(element) {
            let detalles = element.parentNode.nextElementSibling;
            if (detalles.style.display === "none") {
                detalles.style.display = "block";
                element.innerHTML = '<i class="fas fa-chevron-up"></i>';
            } else {
                detalles.style.display = "none";
                element.innerHTML = '<i class="fas fa-chevron-down"></i>';
            }
        }

        // --- L√≥gica de inicializaci√≥n y actualizaci√≥n ---
        document.addEventListener('DOMContentLoaded', () => {
            // Mostrar la secci√≥n de Evidencias por defecto al cargar la p√°gina
            mostrarContenido('Tablero');
            checkSession();
            

        const registroClienteForm = document.getElementById('registroClienteForm');
            if(registroClienteForm) {
                registroClienteForm.addEventListener('submit', registerClient);
            }
        
            // üîë LLAMAR A LA RESTRICCI√ìN AQU√ç üîë
        restrictAdminSection();
        });

        //Cerrar Sesion
        document.getElementById('logout-button').addEventListener('click', logout);

       

    </script>
    
        <!-- Firebase (Compat para FCM en web + SW) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging-compat.js"></script>

    <!-- Tu configuraci√≥n (rellena con tus valores reales) -->
    <script>
    window.FB_CONFIG = {
        apiKey: "AIzaSyBa6KYyhwI4scIblnOY_VKb-1kSwwO9_Ts",
        authDomain: "aetech-notificaciones.firebaseapp.com",
        projectId: "aetech-notificaciones",
        storageBucket: "aetech-notificaciones.firebasestorage.app",
        messagingSenderId: "742322294289",
        appId: "1:742322294289:web:5bd9e894ad92dbef4dabb0",
        vapidKey: "BOTEAlz-7hYedgFy9YSbo3txG_14XJaf0tt4qCCwS3ifs67umn8UDn5fLirfmTmSh17P5r_cUMhrL8uDnZsiWys" // la que te dio Cloud Messaging
    };
    </script>



    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script src="script.js"></script>

    <!-- MODAL PARA VISUALIZAR EVIDENCIAS -->
<div id="modalEvidencias" class="modal">
  <div class="modal-content">
    <span class="close" onclick="cerrarModalEvidencias()">&times;</span>
    <h2>üì∏ Evidencias</h2>

    <div id="contenedorEvidencias"></div>

    <!-- üîπ Bot√≥n de descarga -->
    <button id="btnDescargarEvidencias" class="btn-descargar" onclick="descargarEvidencias()">
      ‚¨áÔ∏è Descargar todas
    </button>
  </div>
</div>



<!-- ========== LISTA DE LEVANTAMIENTOS ========== -->
<div id="listaLevantamientos" class="main-content show">

    <div class="tareas-container">

        <h2 class="section-title">Organizador de Levantamientos</h2>

        <!-- BOT√ìN NUEVO -->
      <button id="btnNuevoLevantamiento"
        class="btn btn-primary"
        style="margin-bottom: 15px;">
    + Nuevo Levantamiento
</button>



        <!-- TABLA -->
        <div class="table-responsive" style="margin-top: 15px;">
          <table class="tabla">
  <thead>
    <tr>
      <th>Cliente</th>
      <th>Direcci√≥n</th>
      <th>Personal</th>
      <th>Fecha</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody id="tablaLevantamientos"></tbody>
</table>

        </div>

    </div>

</div>


<!-- ========== MODAL NUEVO LEVANTAMIENTO (iOS Style) ========== -->
<!-- ========== MODAL NUEVO LEVANTAMIENTO (iOS / Glass) ========== -->
<div id="modalNuevoLevantamiento" class="modalGlass">
    <div class="modalGlass-content">

        <h2 class="modalGlass-title">Nuevo Levantamiento</h2>
        <span class="modalGlass-close" onclick="closeNuevoLevantamiento()">‚úñ</span>
<div class="lev-form-grid">

    <div class="lev-grid-container">
    <div class="lev-input-group">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <label>Cliente:</label>
            <button type="button" onclick="toggleRegistroExpress()" id="btn-express" class="badge-ios" style="background: #007aff20; color: #007aff; border:none; cursor:pointer; font-size:10px;">
                + REGISTRO EXPRESS
            </button>
        </div>
        
        <div id="wrapper-cliente">
            <select id="lev-clienteSelect" class="lev-select-custom" onchange="cargarDireccionesLev()"></select>
            <input type="text" id="express-cliente-nombre" class="glass-input-ios" placeholder="Nombre completo del cliente" style="display: none;">
        </div>
    </div>

    <div class="lev-input-group">
        <label>Direcci√≥n:</label>
        <div id="wrapper-direccion">
            <select id="lev-direccionSelect" class="lev-select-custom"></select>
            <input type="text" id="express-cliente-direccion" class="glass-input-ios" placeholder="Direcci√≥n del servicio" style="display: none;">
        </div>
    </div>
</div>

    <div class="lev-field">
        <label>Personal</label>
        <input id="lev-personal" type="text" readonly>
    </div>

    <div class="lev-field">
        <label>Fecha y Hora</label>
        <input id="lev-fechaHora" type="datetime-local">
    </div>

</div>

        <!-- NECESIDADES -->
        <h4>Necesidades:</h4>
        <div id="lev-necesidadesContainer"></div>
        <button id="btnAddNecesidad" class="btn btn-secondary" type="button">+ Agregar</button>

        <hr>

        <!-- MATERIALES -->
       <h4>Materiales:</h4>

<div class="lev-material-container">
    <select id="levInsumo" onchange="levMostrarCampoExtra()">
        <option value="" disabled selected>Seleccione un insumo</option>

        <optgroup label="Cable">
            <option value="Cable">Cable</option>
        </optgroup>

        <optgroup label="Transceptor">
            <option value="Transceptor">Transceptor</option>
        </optgroup>

        <optgroup label="Conectores">
            <option value="Conector de corriente">Conector de corriente</option>
        </optgroup>

        <optgroup label="Fuente de poder 12V">
            <option value="12vdc 1A">12vdc 1A</option>
            <option value="12vdc 1.5A">12vdc 1.5A</option>
            <option value="12vdc 2A">12vdc 2A</option>
            <option value="12vdc 4.1A">12vdc 4.1A</option>
            <option value="12vdc 5A">12vdc 5A</option>
        </optgroup>

        <optgroup label="Fuente centralizada">
            <option value="Fuente de poder centralizada">Fuente de poder centralizada</option>
        </optgroup>

        <optgroup label="Cajas">
            <option value="Caja estanca">Caja estanca</option>
            <option value="Caja pl√°stica 180x125x57">Caja pl√°stica 180x125x57</option>
            <option value="Caja pl√°stica 190x290x140">Caja pl√°stica 190x290x140</option>
        </optgroup>

        <optgroup label="Otro">
            <option value="Otro">Otro (especificar)</option>
        </optgroup>
    </select>

    <input type="text" id="levInsumoExtra" placeholder="Especificar modelo..."
           style="display:none; margin-top:6px;">

    <input type="number" id="levCantidad" placeholder="Cantidad" min="0">

    <select id="levUnidadOtro" style="display:none;">
        <option value="Metros">Metros</option>
        <option value="Unidades">Unidades</option>
    </select>

    <button id="levBtnAgregarMaterial" class="btn btn-success btn-sm">
        + Agregar
    </button>
</div>

<ul id="levListaMateriales"></ul>




       <button id="btnGuardarLevantamiento" class="btn btn-success">
  Guardar Levantamiento
</button>


    </div>
</div>

<div id="aliasToast" class="glass-toast">
  ‚ö†Ô∏è Recomendado agregar un alias para identificar mejor esta ubicaci√≥n
</div>


<div id="modalVerLevantamiento" class="ios-modal">
  <div class="ios-card">
   

<button class="ios-close" onclick="cerrarVerLevantamiento()">‚úï</button>


    <h2>üìã Levantamiento</h2>

    <div class="ios-field">
      <label>Cliente</label>
      <div id="verCliente"></div>
    </div>

    <div class="ios-field">
      <label>Direcci√≥n</label>
      <div id="verDireccion"></div>
    </div>

    <div class="ios-field">
      <label>Personal</label>
      <div id="verPersonal"></div>
    </div>

    <div class="ios-field">
      <label>Fecha</label>
      <div id="verFecha"></div>
    </div>

    <hr>
<h3>üõ† Necesidades</h3>
<div id="verNecesidades" class="ios-necesidades"></div>


   <h3>üß± Materiales</h3>
<ul id="verMateriales" class="ios-materiales"></ul>

  </div>
</div>



<script>

    let levantamientoEditando = null;
    let levantamientosCache = [];



 document.getElementById("btnLinkARegistro")?.addEventListener("click", () => {
    // 1. Cerrar el modal para que no bloquee la vista
    closeNuevoLevantamiento(); 

    // 2. CAMBIO DE SECCI√ìN:
    // Ocultamos todas las secciones principales
    document.querySelectorAll(".main-content").forEach(sec => sec.classList.remove("show"));
    
    // Mostramos la secci√≥n de Clientes
    const seccionClientes = document.getElementById("Clientes");
    if (seccionClientes) {
        seccionClientes.classList.add("show");
        
        // 3. SCROLL AL FORMULARIO:
        // Esperamos un poquito a que la secci√≥n aparezca para hacer el scroll
        setTimeout(() => {
            const form = document.getElementById("registroClienteForm");
            if (form) {
                form.scrollIntoView({ behavior: "smooth" });
                // Efecto visual para resaltar el formulario
                form.style.boxShadow = "0 0 20px #00938f";
                setTimeout(() => form.style.boxShadow = "", 2000);
            }
        }, 100);
    }
});




/* ===== MODAL NUEVO LEVANTAMIENTO (FORZADO) ===== */

function openNuevoLevantamiento() {
    const LevClienteSelect = document.getElementById('lev-clienteSelect');
    const modal = document.getElementById("modalNuevoLevantamiento");
    modal.classList.add("active");

    cargarClientesLev();   // clientes
    setPersonalActual();   // personal
    setFechaHoraActual();  // üëà fecha y hora autom√°tica
    cargarDireccionesLevantamiento();

    LevClienteSelect.onchange = () => {
        cargarDireccionesLevantamiento(LevClienteSelect.value);
    };
}



function closeNuevoLevantamiento() {
    const modal = document.getElementById("modalNuevoLevantamiento");
    if (modal) modal.classList.remove("active");
}



/* BOT√ìN */
/* BUSCA ESTA PARTE Y D√âJALA AS√ç */
document.getElementById("btnNuevoLevantamiento")
    ?.addEventListener("click", abrirNuevoLevantamiento); // üëà Aseg√∫rate que diga abrirNuevoLevantamiento


async function cargarClientesLev() {
  const select = document.getElementById("lev-clienteSelect");
  if (!select) return;
  select.innerHTML = `<option value="">Seleccione cliente</option>`;

  try {
    const token = localStorage.getItem("accessToken");
    const res = await fetch(`${API_BASE_URL}/clientes`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    const clientes = await res.json();

    // üö® ESTA ES LA L√çNEA CLAVE: Guardar los datos para las direcciones
    window.clientesData = {}; 

    clientes.forEach(c => {
      window.clientesData[c.id] = c; // Guardamos el objeto cliente con sus direcciones
      const opt = document.createElement("option");
      opt.value = c.id;
      opt.textContent = c.nombre;
      select.appendChild(opt);
    });
    return true; 
  } catch (e) { console.error(e); return false; }
}



function cargarDireccionesLevantamiento(clienteId) {
    console.log("Ejecutando cargarDireccionesCliente para cliente:", clienteId);

    const selectDireccion = document.getElementById("lev-direccionSelect");
    if (!selectDireccion) {
        console.error("‚ùå No se encontr√≥ el select lev-direccionSelect");
        return;
    }

    selectDireccion.innerHTML = `<option value="">-- Seleccione Direcci√≥n --</option>`;

    if (!clienteId) {
        return;
    }

    const cliente = window.clientesData ? window.clientesData[clienteId] : null;
    console.log("Cliente encontrado en window.clientesData:", cliente);

    const direcciones = (cliente && Array.isArray(cliente.direcciones))
        ? cliente.direcciones
        : [];

    if (!direcciones.length) {
        selectDireccion.innerHTML = `<option value="">Sin direcciones registradas</option>`;
        return;
    }

  direcciones.forEach(dir => {
  const option = document.createElement("option");
  //option.value = dir.direccion;
  option.value = dir.id; // üëà CLAVE


  option.textContent = dir.alias
    ? `${dir.alias} ‚Äì ${dir.direccion}`
    : dir.maps
      ? "üìç Ubicaci√≥n sin alias (Google Maps)"
      : dir.direccion;

  option.dataset.maps = dir.maps || "";
  selectDireccion.appendChild(option);
});
}
 







function setPersonalActual() {
    const input = document.getElementById("lev-personal");
    if (!input) return;

    input.value =
        localStorage.getItem("userName") ||
        localStorage.getItem("usuario") ||
        localStorage.getItem("nombreUsuario") ||
        "Usuario";
}


let isExpressMode = false;

function toggleRegistroExpress() {
    isExpressMode = !isExpressMode;
    
    const selectCliente = document.getElementById('lev-clienteSelect');
    const inputCliente = document.getElementById('express-cliente-nombre');
    const selectDir = document.getElementById('lev-direccionSelect');
    const inputDir = document.getElementById('express-cliente-direccion');
    const btn = document.getElementById('btn-express');

    if (isExpressMode) {
        // Modo Escritura
        selectCliente.style.display = 'none';
        selectDir.style.display = 'none';
        inputCliente.style.display = 'block';
        inputDir.style.display = 'block';
        
        btn.innerText = "‚Üê VOLVER A LISTA";
        btn.style.color = "#ff9f0a";
        btn.style.background = "#ff9f0a20";
        inputCliente.focus();
    } else {
        // Modo Selecci√≥n
        selectCliente.style.display = 'block';
        selectDir.style.display = 'block';
        inputCliente.style.display = 'none';
        inputDir.style.display = 'none';
        
        btn.innerText = "+ REGISTRO EXPRESS";
        btn.style.color = "#007aff";
        btn.style.background = "#007aff20";
    }
}

// GUARDAR LEVANTAMIENTO 

 document.getElementById("btnGuardarLevantamiento")
        ?.addEventListener("click", guardarLevantamiento)
        console.log("boton funcionando correctamente");

// üí° IMPORTANTE: Aseg√∫rate de tener esta variable declarada al inicio de tus scripts
   let editandoId = null; 

async function guardarLevantamiento() {
    // Referencias a elementos
    const selectCliente = document.getElementById("lev-clienteSelect");
    
    // ‚ùå ANTES: "lev-direccionesLevantamientos"
    // ‚úÖ AHORA: "lev-direccionSelect" (O el ID real que tengas en tu HTML)
    const selectDireccion = document.getElementById("lev-direccionSelect"); 
    
    const inputExpressNombre = document.getElementById("express-cliente-nombre");
    const inputExpressDir = document.getElementById("express-cliente-direccion");

    // ... el resto de tu c√≥digo sigue igual
    let clienteId, clienteNombre, direccionTexto;

    if (isExpressMode) {
        // --- MODO EXPRESS ---
        clienteId = null; // No hay ID porque es nuevo
        clienteNombre = inputExpressNombre.value.trim();
        direccionTexto = inputExpressDir.value.trim();

        if (!clienteNombre || !direccionTexto) {
            alert("‚ö†Ô∏è Por favor escribe el nombre del cliente y la direcci√≥n express.");
            return;
        }
    } else {
        // --- MODO NORMAL ---
        clienteId = selectCliente.value;
        clienteNombre = selectCliente.options[selectCliente.selectedIndex]?.text || "";
        direccionTexto = selectDireccion.options[selectDireccion.selectedIndex]?.text || "";

        if (!clienteId || !direccionTexto || direccionTexto.includes("-- Seleccione")) {
            alert("‚ö†Ô∏è Selecciona cliente y direcci√≥n.");
            return;
        }
    }

    document.getElementById("loader").style.display = "flex";

    const data = {
        cliente_id: clienteId,
        cliente_nombre: clienteNombre,
        direccion: direccionTexto,
        personal: document.getElementById("lev-personal").value,
        fecha: document.getElementById("lev-fechaHora").value,
        necesidades: obtenerNecesidadesLev(), 
        materiales: levMaterialesList,
        es_express: isExpressMode // üëà Avisamos al servidor que es un registro r√°pido
    };

    const url = editandoId 
        ? `${API_BASE_URL}/levantamientos/${editandoId}` 
        : `${API_BASE_URL}/levantamientos`;

    const metodo = editandoId ? "PUT" : "POST";

    try {
        const res = await fetch(url, {
            method: metodo,
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${localStorage.getItem("accessToken")}`
            },
            body: JSON.stringify(data)
        });

        const resData = await res.json();

        if (res.ok) {
            alert("‚úÖ Levantamiento procesado correctamente");
            editandoId = null; 
            location.reload();
        } else {
            alert("‚ùå Error del servidor: " + (resData.msg || resData.message || "Error desconocido"));
        }
    } catch (err) {
        console.error("Error cr√≠tico:", err);
        alert("‚ùå Error de conexi√≥n.");
    } finally {
        document.getElementById("loader").style.display = "none";
    }
}


//LIMPIAR FORMULARIO 
function limpiarFormularioLev() {
    document.getElementById("lev-direccion").value = "";
    document.getElementById("lev-personal").value = "";
    document.getElementById("lev-fechaHora").value = "";
    document.getElementById("lev-clienteSelect").value = "";
    
    // Limpiar las filas de necesidades/fotos
    document.getElementById("lev-necesidadesContainer").innerHTML = "";
    
    // Limpiar la lista de materiales si usas una variable global
    levMaterialesList = [];
    levRenderMateriales(); // Para que la tabla de materiales se vea vac√≠a
}





// ================= DIRECCI√ìN AUTOM√ÅTICA =================
async function clienteChangeLev() {
    const select = document.getElementById("lev-clienteSelect");
    const inputDir = document.getElementById("lev-direccion");

    if (!select || !inputDir || !select.value) {
        inputDir.value = "";
        return;
    }

    const token = localStorage.getItem("accessToken");

    try {
        const res = await fetch(`${API_BASE_URL}/clientes/${select.value}`, {
            headers: { Authorization: `Bearer ${token}` }
        });

        if (!res.ok) {
            console.error("Error al obtener cliente");
            inputDir.value = "";
            return;
        }

        const cliente = await res.json();

        // üëâ toma la primera direcci√≥n en texto
        inputDir.value =
            cliente?.direcciones?.[0]?.direccion ||
            cliente?.direccion ||
            "";
    } catch (e) {
        console.error("Error direcci√≥n:", e);
        inputDir.value = "";
    }
}


// CONECTA LA FUNCI√ìN NUEVA:
document.getElementById("lev-clienteSelect")
    ?.addEventListener("change", (e) => {
        cargarDireccionesLevantamiento(e.target.value);
    });




    // ================= NECESIDADES =================
function addNecesidad() {
    const cont = document.getElementById("lev-necesidadesContainer");
    const div = document.createElement("div");
    div.className = "nec-item";

    div.innerHTML = `
        <div class="nec-row">
            <div class="nec-left">
                <textarea placeholder="Describe la necesidad..." class="form-control"></textarea>
                <img class="img-preview" style="display:none; width:100%; max-width:150px; margin-top:10px; border-radius:5px;">
            </div>
            <div class="nec-right">
                <button type="button" class="btn btn-primary btn-sm btn-foto">üì∏ Foto</button>
                <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.nec-item').remove()">Eliminar</button>
                <input type="file" accept="image/*" style="display:none" class="file-input-nec">
            </div>
        </div>
        <hr>
    `;

    const btnFoto = div.querySelector(".btn-foto");
    const fileInput = div.querySelector(".file-input-nec");
    const imgPreview = div.querySelector(".img-preview");

    btnFoto.onclick = () => fileInput.click();

    // üí° Convertimos a Base64 para que el controlador lo detecte
    fileInput.onchange = () => {
        const file = fileInput.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            imgPreview.src = e.target.result; // Aqu√≠ queda el Base64
            imgPreview.style.display = "block";
            btnFoto.innerText = "‚úÖ Foto Cargada";
            btnFoto.style.backgroundColor = "#28a745";
        };
        reader.readAsDataURL(file);
    };

    cont.appendChild(div);
}


// bot√≥n
document.getElementById("btnAddNecesidad")
    ?.addEventListener("click", addNecesidad);




    //materiales 
function addMaterial() {
    const input = document.getElementById("lev-materialInput");
    const list = document.getElementById("lev-materialesLista");

    if (!input.value.trim()) return;

    const li = document.createElement("li");
    li.innerHTML = `
        ${input.value}
        <button type="button" onclick="this.parentElement.remove()">‚ùå</button>
    `;
    list.appendChild(li);
    input.value = "";
}

//HORA AUTMATICA
function setFechaHoraActual() {
    const input = document.getElementById("lev-fechaHora");
    if (!input) return;

    const now = new Date();
    // Esta l√≠nea ajusta la zona horaria del navegador para que coincida con el input
    const offset = now.getTimezoneOffset() * 60000;
    const localISOTime = (new Date(now - offset)).toISOString().slice(0, 16);
    
    input.value = localISOTime;
}

//materiales 

/* ================= MATERIALES LEVANTAMIENTOS ================= */

let levMaterialesList = [];

const levCategoriaPorInsumo = {
    "Transceptor": "Transceptor",
    "Conector de corriente": "Conectores",

    "12vdc 1A": "Fuentes de poder",
    "12vdc 1.5A": "Fuentes de poder",
    "12vdc 2A": "Fuentes de poder",
    "12vdc 4.1A": "Fuentes de poder",
    "12vdc 5A": "Fuentes de poder",
    "Fuente de poder centralizada": "Fuentes de poder",

    "Cable": "Cableado",

    "Caja estanca": "Cajas",
    "Caja pl√°stica 180x125x57": "Cajas",
    "Caja pl√°stica 190x290x140": "Cajas",

    "Otro": "Otros"
};

const levUnidadesPorInsumo = {
    "Transceptor": "Unidades",
    "Conector de corriente": "Unidades",

    "12vdc 1A": "Unidades",
    "12vdc 1.5A": "Unidades",
    "12vdc 2A": "Unidades",
    "12vdc 4.1A": "Unidades",
    "12vdc 5A": "Unidades",

    "Fuente de poder centralizada": "Unidades",

    "Caja estanca": "Unidades",
    "Caja pl√°stica 180x125x57": "Unidades",
    "Caja pl√°stica 190x290x140": "Unidades",

    "Cable": "Metros",
    "Otro": "Unidades"
};

// ‚ûï AGREGAR MATERIAL
document.getElementById("levBtnAgregarMaterial")
    ?.addEventListener("click", () => {

        const insumoBase = document.getElementById("levInsumo").value;
        const extra = document.getElementById("levInsumoExtra").value.trim();
        const cantidad = document.getElementById("levCantidad").value.trim();

        if (!insumoBase || !cantidad) {
            alert("Completa los campos de material");
            return;
        }

        if ((insumoBase === "Fuente de poder centralizada" || insumoBase === "Otro") && !extra) {
            alert("Especifica el modelo");
            return;
        }

        let unidad;
        if (insumoBase === "Otro") {
            unidad = document.getElementById("levUnidadOtro").value;
            if (!unidad) {
                alert("Selecciona unidad");
                return;
            }
        } else {
            unidad = levUnidadesPorInsumo[insumoBase] || "Unidades";
        }

        const insumoFinal = extra ? `${insumoBase} (${extra})` : insumoBase;
        const categoria = levCategoriaPorInsumo[insumoBase] || "Otros";

        // üîÅ detectar duplicado
        const existente = levMaterialesList.find(
            m => m.insumo === insumoFinal && m.unidad === unidad
        );

        if (existente) {
            existente.cantidad += parseFloat(cantidad);
            levRenderMateriales();
            levLimpiarInputs();
            return;
        }

        levMaterialesList.push({
            insumo: insumoFinal,
            categoria,
            cantidad: parseFloat(cantidad),
            unidad
        });

        levRenderMateriales();
        levLimpiarInputs();
    });

// üßπ LIMPIAR INPUTS
function levLimpiarInputs() {
    document.getElementById("levInsumo").selectedIndex = 0;
    document.getElementById("levCantidad").value = "";
    document.getElementById("levInsumoExtra").value = "";
    document.getElementById("levInsumoExtra").style.display = "none";
    document.getElementById("levUnidadOtro").value = "";
    document.getElementById("levUnidadOtro").style.display = "none";
}

// üñ®Ô∏è RENDER MATERIALES
function levRenderMateriales() {
    const ul = document.getElementById("levListaMateriales");
    ul.innerHTML = "";

    const grupos = {};

    levMaterialesList.forEach(mat => {
        if (!grupos[mat.categoria]) grupos[mat.categoria] = [];
        grupos[mat.categoria].push(mat);
    });

    Object.keys(grupos).sort().forEach(cat => {

        const header = document.createElement("li");
        header.innerHTML = `<strong>${cat}</strong>`;
        header.style.marginTop = "10px";
        ul.appendChild(header);

        grupos[cat].forEach(mat => {
            const li = document.createElement("li");
            li.innerHTML = `
                ${mat.insumo} ‚Äì ${mat.cantidad} ${mat.unidad}
                <button class="levBtnEliminarMat">‚ùå</button>
            `;

            li.querySelector(".levBtnEliminarMat").onclick = () => {
                levMaterialesList = levMaterialesList.filter(
                    m => !(m.insumo === mat.insumo && m.unidad === mat.unidad)
                );
                levRenderMateriales();
            };

            ul.appendChild(li);
        });
    });
}

// üëÅÔ∏è MOSTRAR CAMPOS EXTRA
function levMostrarCampoExtra() {
    const insumo = document.getElementById("levInsumo").value;
    const extra = document.getElementById("levInsumoExtra");
    const unidadOtro = document.getElementById("levUnidadOtro");

    if (insumo === "Fuente de poder centralizada" || insumo === "Otro") {
        extra.style.display = "block";
    } else {
        extra.style.display = "none";
        extra.value = "";
    }

    if (insumo === "Otro") {
        unidadOtro.style.display = "block";
    } else {
        unidadOtro.style.display = "none";
        unidadOtro.value = "";
    }
}


//cargar tabla 

async function cargarTablaLevantamientos() {
  const res = await fetch(`${API_BASE_URL}/levantamientos`, {
    headers: {
      Authorization: `Bearer ${localStorage.getItem("userToken")}`
    }
  });

  const data = await res.json();
  levantamientosCache = data;

  const tbody = document.getElementById("tablaLevantamientos");
  tbody.innerHTML = "";

  data.forEach(l => {
    // üí° PostgreSQL a veces usa 'id', aseg√∫rate que el campo existe
    const idReal = l.id || l.id_levantamiento; 

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${l.cliente_nombre || 'Sin nombre'}</td>
      <td>${l.direccion}</td>
      <td>${l.personal}</td>
      <td>${new Date(l.fecha).toLocaleString()}</td>
      
      <td class="acciones">
        <button onclick="editarLevantamiento('${idReal}')">Editar</button>
        <button onclick="eliminarLevantamiento('${idReal}')">Eliminar</button>
        <button onclick="verLevantamiento('${idReal}')">Ver</button>
        <button onclick="pdfLevantamiento('${idReal}')">PDF</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

cargarTablaLevantamientos();

//obtener necesidades 

function obtenerNecesidadesLev() {
  const necesidades = [];
  const filas = document.querySelectorAll("#lev-necesidadesContainer .nec-item");

  filas.forEach(f => {
    const desc = f.querySelector("textarea").value;
    const img = f.querySelector(".img-preview").src;

    // Solo enviamos si tiene texto o si tiene una imagen (Base64 o URL existente)
    if (desc.trim() !== "" || (img && img.startsWith("data:image")) || (img && img.startsWith("http"))) {
      necesidades.push({
        descripcion: desc,
        imagen: img 
      });
    }
  });
  return necesidades;
}


//editar el levantamiento

async function editarLevantamiento(id) {
    try {
        document.getElementById("loader").style.display = "flex";
        
        const res = await fetch(`${API_BASE_URL}/levantamientos/${id}`, {
            headers: { "Authorization": `Bearer ${localStorage.getItem("accessToken")}` }
        });
        const lev = await res.json();

        editandoId = id; 

        // 1. Cargamos los clientes
        await cargarClientesLev(); 

        const selectCliente = document.getElementById("lev-clienteSelect");
        if (selectCliente) {
            selectCliente.value = lev.cliente_id; 
        }

        // 2. Cargamos las direcciones de ese cliente
        await cargarDireccionesLevantamiento(lev.cliente_id);

        // üö® CORRECCI√ìN PARA LA DIRECCI√ìN VIEJA
        const selectDirReal = document.getElementById("lev-direccionesLevantamientos");
        if (selectDirReal) {
            // Buscamos entre las opciones cu√°l coincide con el texto guardado
            let encontrada = false;
            for (let i = 0; i < selectDirReal.options.length; i++) {
                // Comparamos el texto de la opci√≥n con la direcci√≥n guardada
                if (selectDirReal.options[i].textContent.includes(lev.direccion) || 
                    selectDirReal.options[i].value == lev.direccion) {
                    selectDirReal.selectedIndex = i;
                    encontrada = true;
                    break;
                }
            }
        }

        // 3. Llenar personal
        const inputPersonal = document.getElementById("lev-personal");
        if (inputPersonal) inputPersonal.value = lev.personal;

        // 4. Formatear Fecha
        if (lev.fecha) {
            const fechaFormateada = new Date(lev.fecha).toISOString().slice(0, 16);
            document.getElementById("lev-fechaHora").value = fechaFormateada;
        }

        // 5. Cargar necesidades
        const container = document.getElementById("lev-necesidadesContainer");
        container.innerHTML = ""; 
        if (lev.necesidades && Array.isArray(lev.necesidades)) {
            lev.necesidades.forEach(n => {
                addNecesidadConDatos(n.descripcion, n.imagen);
            });
        }

        // 6. Cargar materiales
        levMaterialesList = Array.isArray(lev.materiales) ? lev.materiales : [];
        levRenderMateriales();

        // UI
        const tituloModal = document.querySelector("#modalNuevoLevantamiento h2");
        if (tituloModal) tituloModal.innerText = "‚úèÔ∏è Editar Levantamiento";
        document.getElementById("modalNuevoLevantamiento").classList.add("active");

    } catch (err) {
        console.error("Error al editar:", err);
        alert("Error al cargar datos del levantamiento amiko");
    } finally {
        document.getElementById("loader").style.display = "none";
    }
}


//ver texto y fotos viejas del levantamieno al editar 
function addNecesidadConDatos(descripcion, urlFoto) {
    addNecesidad(); // Crea la fila vac√≠a con toda su l√≥gica de botones
    const filas = document.querySelectorAll("#lev-necesidadesContainer .nec-item");
    const ultimaFila = filas[filas.length - 1];
    
    if (ultimaFila) {
        // Ponemos el texto
        ultimaFila.querySelector("textarea").value = descripcion || "";
        
        // Ponemos la foto si existe
        if (urlFoto) {
            const img = ultimaFila.querySelector(".img-preview");
            img.src = urlFoto; // El src puede ser el link de Cloudinary
            img.style.display = "block";
            ultimaFila.querySelector(".btn-foto").innerText = "‚úÖ Foto Actual";
            ultimaFila.querySelector(".btn-foto").classList.replace("btn-primary", "btn-success");
        }
    }
}

//ELIMINAR LEANTAMIENTO 
function eliminarLevantamiento(id) {
  if (!confirm("¬øEliminar levantamiento?")) return;

  fetch(`${API_BASE_URL}/levantamientos/${id}`, {
    method: "DELETE",
    headers: {
      Authorization: `Bearer ${localStorage.getItem("userToken")}`
    }
  }).then(() => cargarTablaLevantamientos());
}





//ver levantamiento
async function verLevantamiento(id) {
  try {
    const res = await fetch(`${API_BASE_URL}/levantamientos/${id}`, {
      headers: { 
        "Authorization": `Bearer ${localStorage.getItem("userToken")}` 
      }
    });

    if (!res.ok) throw new Error("No se encontr√≥ el registro");

    const lev = await res.json();

    // 1. Datos b√°sicos
    document.getElementById("verCliente").textContent = lev.cliente_nombre || "Sin nombre";
    document.getElementById("verDireccion").textContent = lev.direccion || "Sin direcci√≥n";
    document.getElementById("verPersonal").textContent = lev.personal || "N/A";
    document.getElementById("verFecha").textContent = new Date(lev.fecha).toLocaleString();

    // 2. Necesidades (Descripci√≥n + Imagen de Cloudinary)

    // Dentro de verLevantamiento(id), en la parte de Necesidades:
const necCont = document.getElementById("verNecesidades");
necCont.innerHTML = "";

if (lev.necesidades && lev.necesidades.length > 0) {
  lev.necesidades.forEach(n => {
    const div = document.createElement("div");
    div.className = "necesidad-detalle";
    div.style.marginBottom = "20px";

    // üí° L√≥gica para la imagen:
    let rutaImagen = "";
    if (n.imagen) {
      // Si la imagen ya es una URL completa (http...), √∫sala tal cual
      if (n.imagen.startsWith('http')) {
        rutaImagen = n.imagen;
      } else {
        // Si es una ruta relativa (/uploads...), b√∫scala en RENDER, no en Netlify
        rutaImagen = `${API_BASE_URL.replace('/api', '')}${n.imagen}`;
      }
    }

    div.innerHTML = `
      <p><strong>Descripci√≥n:</strong> ${n.descripcion}</p>
      ${rutaImagen ? `<img src="${rutaImagen}" style="width:100%; border-radius:8px; margin-top:10px;" alt="Foto de necesidad">` : '<p><i>Sin imagen disponible</i></p>'}
    `;
    necCont.appendChild(div);
  });
}

    // 3. Materiales
    renderMaterialesVer(lev.materiales || []);

    // 4. Mostrar el modal
    document.getElementById("modalVerLevantamiento").classList.add("active");

  } catch (err) {
    console.error(err);
    alert("error al cargar el detalle: " + err.message);
  }
}





function pdfLevantamiento(id) {
  window.open(`${API_BASE_URL}/levantamientos/${id}/pdf`, "_blank");
}





//NECESIDADES REGISTRADAS 
function renderNecesidadesVer(necesidades = []) {
  const cont = document.getElementById("verNecesidades");
  cont.innerHTML = "";

  if (necesidades.length === 0) {
    cont.innerHTML = "<p>No hay fotos o necesidades registradas.</p>";
    return;
  }

  necesidades.forEach(n => {
    const div = document.createElement("div");
    div.className = "ver-necesidad";

    // Si la imagen es un link de Cloudinary, se usa directo
    // Si es ruta relativa, le pegamos la URL del Render
    let srcImagen = n.imagen;
    if (srcImagen && !srcImagen.startsWith('http')) {
        const urlServidor = API_BASE_URL.replace('/api', '');
        srcImagen = `${urlServidor}/${srcImagen}`;
    }

    div.innerHTML = `
      <p><strong>Descripci√≥n:</strong> ${n.descripcion || "Sin descripci√≥n"}</p>
      ${srcImagen ? `<img src="${srcImagen}" style="width:100%; max-width:400px; border-radius:8px; margin-bottom:15px;">` : ""}
    `;
    cont.appendChild(div);
  });
}



//MATERIALES 
function renderMaterialesVer(materiales = []) {
  const ul = document.getElementById("verMateriales");
  ul.innerHTML = "";

  if (!materiales.length) {
    ul.innerHTML = "<li class='muted'>Sin materiales</li>";
    return;
  }

  materiales.forEach(m => {
    const li = document.createElement("li");
    li.textContent = `${m.insumo} ‚Äì ${m.cantidad} ${m.unidad}`;
    ul.appendChild(li);
  });
}


//CERRAR EL LEVANTAMIENTO 

function cerrarVerLevantamiento() {
    document.getElementById("modalVerLevantamiento")
        .classList.remove("active");
}


//limpiar formulario 
function limpiarFormularioLev() {
  // limpiar materiales
  levMaterialesList = [];
  document.getElementById("levListaMateriales").innerHTML = "";

  // limpiar necesidades
  document.getElementById("lev-necesidadesContainer").innerHTML = "";
}


console.log("JS LEVANTAMIENTOS CARGADO");


function addNecesidadConDatos(descripcion, urlFoto) {
    addNecesidad(); // Crea la fila vac√≠a
    const filas = document.querySelectorAll("#lev-necesidadesContainer .nec-item");
    const ultimaFila = filas[filas.length - 1];
    
    if (ultimaFila) {
        ultimaFila.querySelector("textarea").value = descripcion || "";
        if (urlFoto) {
            const img = ultimaFila.querySelector(".img-preview");
            img.src = urlFoto;
            img.style.display = "block";
            ultimaFila.querySelector(".btn-foto").innerText = "‚úÖ Foto Cargada";
        }
    }
}



//se suben las imagenes al cloudinary 
async function subirImagenCloudinary(file) {
  const formData = new FormData();
  formData.append("file", file);
  formData.append("upload_preset", "tu_preset_aqui"); // Aseg√∫rate de tener tu preset

  try {
    const res = await fetch("https://api.cloudinary.com/v1_1/tu_cloud_name/image/upload", {
      method: "POST",
      body: formData
    });
    const data = await res.json();
    console.log("URL de Cloudinary generada:", data.secure_url);
    return data.secure_url; // üí° Esto es lo que debemos guardar
  } catch (err) {
    console.error("Error al subir a Cloudinary:", err);
    return null;
  }
}


//limpia xd 
function cerrarNuevoLevantamiento() {
    // 1. Quitamos la clase para ocultar el modal
    document.getElementById("modalNuevoLevantamiento").classList.remove("active");
    
    // 2. üö® CRUCIAL: Resetear el ID de edici√≥n a null
    editandoId = null; 
    
    // 3. üö® CRUCIAL: Regresar el t√≠tulo a "Nuevo"
    document.querySelector("#modalNuevoLevantamiento h2").innerText = "üìã Nuevo Levantamiento";
    
    // 4. Limpiar todos los campos (input, select, textareas)
    limpiarFormularioLev(); 
}





/* ===== FUNCI√ìN UNIFICADA PARA NUEVO LEVANTAMIENTO CORREGIDA ===== */
async function abrirNuevoLevantamiento() {
    // 1. Resetear el estado de edici√≥n
    editandoId = null; 
    
    // 2. Limpiar campos
    const campos = ["lev-direccion", "lev-personal", "lev-fechaHora"];
    campos.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = "";
    });

    // 3. üö® CARGAR CLIENTES (Esto es lo que faltaba amiko)
    await cargarClientesLev(); 

    // 4. Limpiar contenedores din√°micos
    document.getElementById("lev-necesidadesContainer").innerHTML = "";
    levMaterialesList = [];
    levRenderMateriales();

    // 5. Cargar datos autom√°ticos (Fecha y Personal)
    setPersonalActual();
    setFechaHoraActual();

    // 6. Cambiar el t√≠tulo y mostrar
    const titulo = document.querySelector("#modalNuevoLevantamiento h2");
    if (titulo) titulo.innerText = "üìã Nuevo Levantamiento";
    
    document.getElementById("modalNuevoLevantamiento").classList.add("active");
}




//GENERAR Y DESCARGAR EL REPORTE PDF 

async function pdfLevantamiento(id) {
    try {
        document.getElementById("loader").style.display = "flex";

        // üëá F√≠jate en el orden: /id/pdf (Igual que en tu archivo de rutas)
        const res = await fetch(`${API_BASE_URL}/levantamientos/${id}/pdf`, {
            method: 'GET',
            headers: {
                "Authorization": `Bearer ${localStorage.getItem("accessToken")}`
            }
        });

        if (!res.ok) throw new Error("Error al generar PDF");

        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Levantamiento_${id}.pdf`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);

    } catch (err) {
        console.error(err);
        alert("Amiko, no se pudo descargar el PDF.");
    } finally {
        document.getElementById("loader").style.display = "none";
    }
}


//si llegas a leer esto me aburri tanto que empece a poner cosas bien randoms por que me aburri y gemini me dijo que pusiera cosas clave xd 

</script>







</body>
</html>